using Autodesk.AutoCAD.DatabaseServices; using Autodesk.AutoCAD.Runtime; using DTS_Engine.Core.Data; using DTS_Engine.Core.Engines; using DTS_Engine.Core.Interfaces; using DTS_Engine.Core.Utils;  namespace DTS_Engine.Commands {     /// <summary>     /// Cac lenh tien ich chung cho DTS Engine.     /// Tuan thu ISO/IEC 25010: Usability, Maintainability.     /// </summary>     public class UtilityCommands : CommandBase     {         /// <summary>         /// Hien thi danh sach lenh DTS.         /// </summary>         [CommandMethod("DTS_HELP")]         public void DTS_HELP()         {             WriteMessage("================================================================");             WriteMessage("   DTS TOOL - DANH SÁCH LỆNH v2.4.0                            ");             WriteMessage("================================================================");             WriteMessage(" THIẾT LẬP:                                                    ");             WriteMessage("   DTS_SET_ORIGIN  - Thiết lập Origin cho tầng                 ");             WriteMessage("   DTS_LINK        - Liên kết phần tử (hỗ trợ Reference)        ");             WriteMessage("   DTS_LINK_ORIGIN - Liên kết phần tử với Story Origin          ");             WriteMessage("   DTS_UNLINK      - Gỡ liên kết cụ thể giữa Con và Cha        ");             WriteMessage("   DTS_CLEAR_LINK  - Xóa toàn bộ liên kết của phần tử          ");             WriteMessage("   DTS_SHOW_LINK   - Hiển thị và kiểm tra liên kết             ");             WriteMessage("----------------------------------------------------------------");             WriteMessage(" SAP2000:                                                      ");             WriteMessage("   DTS_TEST_SAP    - Kiểm tra kết nối SAP2000                  ");             WriteMessage("   DTS_GET_FRAMES  - Lấy danh sách frames từ SAP               ");             WriteMessage("   DTS_SYNC_SAP    - Đồng bộ SAP -> CAD (PULL)                 ");             WriteMessage("   DTS_PUSH_LOAD   - Gán tải CAD -> SAP (PUSH)                ");             WriteMessage("   DTS_CHECK_SYNC  - Kiểm tra trạng thái đồng bộ               ");             WriteMessage("----------------------------------------------------------------");             WriteMessage(" KIỂM TOÁN TẢI TRỌNG (MỚI v2.4):                               ");             WriteMessage("   DTS_AUDIT_SAP2000  - Kiểm toán tải trọng đầy đủ             ");             WriteMessage("   DTS_LOAD_SUMMARY   - Tóm tắt nhanh tải theo pattern         ");             WriteMessage("   DTS_CHECK_REACTIONS- Kiểm tra phản lực đáy                  ");             WriteMessage("   DTS_LIST_LOADED_ELEMENTS - Liệt kê phần tử có tải           ");             WriteMessage("   DTS_EXPORT_LOADS_CSV - Xuất tải ra file CSV                 ");             WriteMessage("----------------------------------------------------------------");             WriteMessage(" TÍNH TOÁN:                                                    ");             WriteMessage("   DTS_CALC_LOAD   - Tính tải trọng tường                      ");             WriteMessage("   DTS_CALC_ALL    - Tính tải cho tất cả phần tử ILoadBearing  ");             WriteMessage("   DTS_SCAN        - Quét và kiểm tra thông tin đối tượng      ");             WriteMessage("----------------------------------------------------------------");             WriteMessage(" HIỂN THỊ & DỌN DẸP:                                           ");             WriteMessage("   DTS_SHOW_LABEL  - Hiển thị/Cập nhật nhãn phần tử            ");             WriteMessage("   DTS_CLEAR_LABEL - Xóa tất cả nhãn                           ");             WriteMessage("   DTS_CLEAR_VISUAL- Xóa hiển thị tạm thời (Transient)         ");             WriteMessage("   DTS_CLEANUP     - Dọn dẹp tất cả layer tạm                  ");             WriteMessage("----------------------------------------------------------------");             WriteMessage(" MÀU SẮC TRẠNG THÁI:                                           ");             WriteMessage("   Xanh lá (3)  - Đã đồng bộ / Full match                     ");             WriteMessage("   Vàng (2)     - CAD thay đổi / Partial match                ");             WriteMessage("   Xanh dương(5)- SAP thay đổi                                ");             WriteMessage("   Đỏ (1)       - Không map / SAP đã xóa                      ");             WriteMessage("   Magenta (6)  - Xung đột                                     ");             WriteMessage("   Cyan (4)     - Phần tử mới                                  ");             WriteMessage("================================================================");         }          /// <summary>         /// Hien thi thong tin phien ban DTS Engine.         /// </summary>         [CommandMethod("DTS_VERSION")]         public void DTS_VERSION()         {             WriteMessage("================================================================");             WriteMessage("  DTS ENGINE v2.4.0 - Load Audit & Verification                ");             WriteMessage("  BY THANHTDVNCC / CTCI VIETNAM                                ");             WriteMessage("  ISO/IEC 25010 & ISO/IEC 12207 Compliant                      ");             WriteMessage("                                                               ");             WriteMessage("  New in v2.4.0:                                               ");             WriteMessage("  - SAP2000 Load Audit: Kiểm toán tải trọng tự động            ");             WriteMessage("  - Multi-pattern Support: DL, SDL, LL, WX, WY...              ");             WriteMessage("  - Area/Frame/Point Load Reading từ SAP2000                   ");             WriteMessage("  - Base Reaction Verification: So sánh với phản lực           ");             WriteMessage("  - CSV Export: Xuất dữ liệu để xử lý trong Excel              ");             WriteMessage("  - NetTopologySuite: Union/Slice geometry                     ");             WriteMessage("================================================================");         }           /// <summary>         /// Hiển thị/Cập nhật nhãn cho các phần tử đã có dữ liệu         /// </summary>         [CommandMethod("DTS_SHOW_LABEL", CommandFlags.UsePickSet)]         public void DTS_SHOW_LABEL()         {             WriteMessage("HIỂN THỊ NHÃN PHẦN TỬ");              var selection = AcadUtils.SelectObjectsOnScreen("");             if (selection.Count == 0)             {                 WriteMessage("Không có đối tượng nào được chọn.");                 return;             }              AcadUtils.CreateLayer("dts_frame_label", 254);              int successCount = 0;             int ignoreCount = 0;              UsingTransaction(tr =>   {       foreach (ObjectId id in selection)       {           if (LabelUtils.RefreshEntityLabel(id, tr))           {               successCount++;           }           else           {               ignoreCount++;           }       }   });              WriteMessage($"Đã cập nhật nhãn: {successCount} phần tử");             if (ignoreCount > 0)             {                 WriteMessage($"Bỏ qua: {ignoreCount} phần tử (chưa có dữ liệu DTS)");                 WriteMessage("Gợi ý: Dùng lệnh DTS_SET_TYPE hoặc DTS_SCAN để đăng ký phần tử trước.");             }         }          /// <summary>         /// Tính tải trọng tường         /// </summary>         [CommandMethod("DTS_CALC_LOAD")]         public void DTS_CALC_LOAD()         {             WriteMessage("TÍNH TẢI TRỌNG TƯỜNG");              // Hiển thị bảng tra nhanh             var loadTable = LoadCalculator.GetQuickLoadTable();              WriteMessage("\nBảng tra nhanh (chiều cao 3300mm, trừ dầm 400mm):");             WriteMessage("---------------------------------------");             WriteMessage("| Độ dày (mm) | Tải (kN/m) |");             WriteMessage("---------------------------------------");              foreach (var item in loadTable)             {                 WriteMessage($"| {item.Key,11} | {item.Value,10:0.00} |");             }              WriteMessage("---------------------------------------");              // Cho phép nhập tùy chỉnh             var thicknessOpt = new Autodesk.AutoCAD.EditorInput.PromptDoubleOptions("\nNhập độ dày tường để tính (mm, 0 để bỏ qua): ")             {                 DefaultValue = 0,                 AllowNegative = false             };              var thicknessRes = Ed.GetDouble(thicknessOpt);             if (thicknessRes.Status == Autodesk.AutoCAD.EditorInput.PromptStatus.OK && thicknessRes.Value > 0)             {                 var calc = new LoadCalculator();                 double load = calc.CalculateLineLoadWithDeduction(thicknessRes.Value);                 WriteMessage($"Tường {thicknessRes.Value}mm: {load:0.00} kN/m");             }         }          /// <summary>         /// Tính tải cho tất cả phần tử ILoadBearing được chọn         /// </summary>         [CommandMethod("DTS_CALC_ALL")]         public void DTS_CALC_ALL()         {             WriteMessage("TÍNH TẢI CHO TẤT CẢ PHẦN TỬ ILOADBEARING");              var selection = AcadUtils.SelectObjectsOnScreen("");             if (selection.Count == 0)             {                 WriteMessage("Không có đối tượng nào được chọn.");                 return;             }              var calc = new LoadCalculator();             int wallCount = 0, beamCount = 0, slabCount = 0, otherCount = 0;              UsingTransaction(tr =>                   {                       foreach (ObjectId id in selection)                       {                           DBObject obj = tr.GetObject(id, OpenMode.ForWrite);                           var elemData = XDataUtils.ReadElementData(obj);                            if (elemData == null) continue;                            // Check if element supports ILoadBearing                           if (elemData is ILoadBearing loadBearing)                           {                               // Calculate loads using polymorphism                               calc.CalculateAndAssign(loadBearing);                                // Save updated data                               XDataUtils.WriteElementData(obj, elemData, tr);                                // Count by type                               if (elemData is WallData) wallCount++;                               else if (elemData is BeamData) beamCount++;                               else if (elemData is SlabData) slabCount++;                               else otherCount++;                           }                       }                   });              WriteMessage($"\nĐã tính tải cho:");             if (wallCount > 0) WriteMessage($"  - Tường (Wall): {wallCount}");             if (beamCount > 0) WriteMessage($"  - Dầm (Beam): {beamCount}");             if (slabCount > 0) WriteMessage($"  - Sàn (Slab): {slabCount}");             if (otherCount > 0) WriteMessage($"  - Khác: {otherCount}");             WriteSuccess($"Tổng: {wallCount + beamCount + slabCount + otherCount} phần tử");         }          /// <summary>         /// Xóa tất cả nhãn trên layer dts_frame_label         /// </summary>         [CommandMethod("DTS_CLEAR_LABEL")]         public void DTS_CLEAR_LABEL()         {             WriteMessage("XÓA TẤT CẢ NHÃN");              AcadUtils.ClearLayer("dts_frame_label");             AcadUtils.ClearLayer("dts_labels");              WriteSuccess("Đã xóa tất cả nhãn");         }          /// <summary>         /// Xóa tất cả layer tạm.         /// </summary>         [CommandMethod("DTS_CLEANUP")]         public void DTS_CLEANUP()         {             WriteMessage("DỌN DẸP LAYER TẠM VÀ HIỂN THỊ");              // Xóa transient graphics trước             VisualUtils.ClearAll();              string[] tempLayers = {                 "dts_linkmap",                 "dts_highlight",                 "dts_mapping",                 "dts_labels",                 "dts_temp",                 "dts_frame_label",                 "dts_scan_link"             };              int totalCleared = 0;             foreach (var layer in tempLayers)             {                 AcadUtils.ClearLayer(layer);                 totalCleared++;             }              WriteSuccess($"Đã dọn dẹp {totalCleared} layer tạm và hiển thị Transient.");         }          /// <summary>         /// Xóa tất cả hiển thị tạm thời (Transient Graphics).         /// Lệnh alias cho DTS_CLEAR_VISUAL trong LinkCommands.         /// </summary>         [CommandMethod("DTS_CLEAR_TRANSIENT")]         public void DTS_CLEAR_TRANSIENT()         {             VisualUtils.ClearAll();             WriteSuccess("Đã xóa hiển thị tạm thời (Transient Graphics).");         }          /// <summary>         /// Hiển thị thông tin ILoadBearing của phần tử được chọn         /// </summary>         [CommandMethod("DTS_SHOW_LOADS")]         public void DTS_SHOW_LOADS()         {             WriteMessage("HIỂN THỊ THÔNG TIN TẢI TRỌNG (ILOADBEARING)");              var selection = AcadUtils.SelectObjectsOnScreen("");             if (selection.Count == 0)             {                 WriteMessage("Không có đối tượng nào được chọn.");                 return;             }              UsingTransaction(tr =>                     {                         foreach (ObjectId id in selection)                         {                             DBObject obj = tr.GetObject(id, OpenMode.ForRead);                             var elemData = XDataUtils.ReadElementData(obj);                              if (elemData == null)                             {                                 WriteMessage($"[{id.Handle}]: Không có dữ liệu DTS");                                 continue;                             }                              WriteMessage($"\n[{id.Handle}] {elemData.ElementType}:");                              if (elemData is ILoadBearing loadBearing)                             {                                 if (loadBearing.HasLoads)                                 {                                     WriteMessage($"  Loads ({loadBearing.Loads.Count}):");                                     foreach (var load in loadBearing.Loads)                                     {                                         WriteMessage($"    - {load}");                                     }                                 }                                 else                                 {                                     WriteMessage("  No loads calculated. Run DTS_CALC_ALL first.");                                 }                                  WriteMessage($"  Mappings: {elemData.Mappings?.Count ?? 0}");                             }                             else                             {                                 WriteMessage("  [Not ILoadBearing - cannot assign loads]");                             }                         }                     });         }     } }