<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thuyết minh tính toán cốt thép</title>
    <style>
        :root {
            --primary-color: #0078d4;
            --bg-sidebar: #f8f9fa;
            --bg-header: #ffffff;
            --border-color: #dee2e6;
            --text-color: #212529;
            --table-header-bg: #e9ecef;
            --hover-color: #e8f0fe;
            --success-color: #198754;
            --warning-color: #fd7e14;
            --danger-color: #dc3545;
            --sidebar-width: 200px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            height: 100vh;
            overflow: hidden;
            color: var(--text-color);
            background-color: white;
            font-size: 12px;
        }

        /* --- SIDEBAR --- */
        .sidebar {
            width: var(--sidebar-width);
            min-width: var(--sidebar-width);
            background-color: var(--bg-sidebar);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            transition: margin-left 0.3s ease, min-width 0.3s ease, width 0.3s ease;
        }

        .sidebar.compact {
            width: 60px;
            min-width: 60px;
        }

        .sidebar.compact .sidebar-header span,
        .sidebar.compact .section-count {
            display: none;
        }

        .sidebar.compact .group-item {
            text-align: center;
            padding: 8px 4px;
            font-size: 10px;
            word-wrap: break-word;
            line-height: 1.1;
        }

        .sidebar.compact .group-item .section-name {
            display: block;
            /* Hiện tên tiết diện kể cả khi compact */
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .sidebar.compact .group-item::before {
            display: none;
            /* Bỏ dấu chấm */
        }

        .sidebar.compact .group-item.active::before {
            color: white;
        }

        .sidebar-header {
            padding: 10px 12px;
            font-weight: 600;
            background-color: #f1f3f5;
            border-bottom: 1px solid var(--border-color);
            font-size: 12px;
            color: #495057;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sidebar-toggle {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            color: #666;
            font-size: 14px;
        }

        .sidebar-toggle:hover {
            background: #e9ecef;
        }

        .group-list {
            flex: 1;
            overflow-y: auto;
            list-style: none;
        }

        .group-item {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #e9ecef;
            transition: all 0.15s;
        }

        .group-item:hover {
            background-color: #e2e6ea;
        }

        .group-item.active {
            background-color: var(--primary-color);
            color: white;
            border-left: 3px solid #005a9e;
            padding-left: 9px;
        }

        .section-name {
            font-weight: 600;
            font-size: 12px;
            margin-bottom: 2px;
        }

        .section-count {
            font-size: 10px;
            color: #6c757d;
        }

        .section-dims {
            font-size: 10px;
            color: #888;
            margin-top: 1px;
        }

        .group-item.active .section-dims {
            color: #e9ecef;
        }

        .group-item.active .section-count {
            color: #e9ecef;
        }

        /* --- MAIN CONTENT --- */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-width: 0;
        }

        /* --- TOP BAR --- */
        .top-bar {
            padding: 6px 12px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-header);
            gap: 12px;
            flex-wrap: wrap;
        }

        .top-bar-left {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .sidebar-expand-btn {
            display: none;
        }

        /* Ẩn expand btn vì chúng ta dùng sidebar compact */

        .report-title h2 {
            font-size: 14px;
            font-weight: 600;
        }

        .report-title span {
            color: var(--primary-color);
        }

        /* --- VIEW CONTROLS --- */
        .view-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .switch-wrapper {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            background: #f8f9fa;
            padding: 3px 8px;
            border-radius: 16px;
            border: 1px solid #dee2e6;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 32px;
            height: 16px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #adb5bd;
            transition: .3s;
            border-radius: 16px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 12px;
            width: 12px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .3s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: var(--primary-color);
        }

        input:checked+.slider:before {
            transform: translateX(16px);
        }

        /* Zoom Controls */
        .zoom-controls {
            display: flex;
            align-items: center;
            gap: 4px;
            background: #f8f9fa;
            padding: 2px 6px;
            border-radius: 4px;
            border: 1px solid #dee2e6;
        }

        .zoom-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 2px 6px;
            font-size: 14px;
            color: #666;
            border-radius: 2px;
        }

        .zoom-btn:hover {
            background: #e9ecef;
        }

        .zoom-label {
            font-size: 10px;
            min-width: 36px;
            text-align: center;
        }

        /* --- SPAN TABS --- */
        .span-tabs {
            display: flex;
            background-color: #f8f9fa;
            border-bottom: 1px solid var(--border-color);
            padding: 0 8px;
            overflow-x: auto;
            min-height: 32px;
            align-items: flex-end;
        }

        .tab-btn {
            padding: 6px 16px;
            border: 1px solid transparent;
            border-bottom: none;
            background: none;
            cursor: pointer;
            font-weight: 500;
            color: #666;
            margin-right: 2px;
            border-radius: 4px 4px 0 0;
            transition: all 0.15s;
            font-size: 11px;
        }

        .tab-btn:hover {
            background-color: #e9ecef;
            color: #333;
        }

        .tab-btn.active {
            background-color: white;
            color: var(--primary-color);
            font-weight: 600;
            border-color: var(--border-color);
            border-bottom: 2px solid white;
            margin-bottom: -1px;
        }

        /* --- DATA AREA --- */
        .data-container {
            flex: 1;
            padding: 12px;
            overflow: auto;
            background: #fafafa;
        }

        .span-info-panel {
            margin-bottom: 12px;
            padding: 10px 14px;
            background-color: #fff;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 24px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .span-info-panel .span-title {
            font-size: 15px;
            font-weight: 700;
            color: #333;
        }

        .span-info-panel .span-details {
            display: flex;
            gap: 16px;
            color: #666;
            font-size: 12px;
        }

        /* --- TABLE STYLES (COMPACT) --- */
        .table-wrapper {
            background: white;
            border-radius: 6px;
            border: 1px solid #ccc;
            overflow: auto;
            /* Changed to auto to handle transformed scale overflow */
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
            display: flex;
            justify-content: center;
        }

        table.calc-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
            transform-origin: top center;
            backface-visibility: hidden;
            /* Force hardware acceleration for sharper text */
        }

        .calc-table th,
        .calc-table td {
            border: 1px solid #e0e0e0;
            padding: 4px 6px;
            text-align: center;
            vertical-align: middle;
        }

        .calc-table thead th {
            background-color: #4a5568;
            color: white;
            font-weight: 600;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            border-color: #3d4852;
        }

        .calc-table tbody tr {
            transition: background 0.1s;
        }

        .calc-table tbody tr:nth-child(even) {
            background-color: #fafafa;
        }

        .calc-table tbody tr:hover {
            background-color: var(--hover-color);
        }

        /* Section Separators */
        .row-separator td {
            background-color: #e2e8f0;
            height: 4px;
            padding: 0;
            border: none;
        }

        /* Category cells */
        .cat-cell {
            font-weight: 600;
            background: #f1f5f9 !important;
            color: #334155;
            font-size: 10px;
            text-transform: uppercase;
        }

        .item-cell {
            font-weight: 600;
            text-align: left !important;
            color: #475569;
            font-size: 11px;
        }

        .sub-cell {
            text-align: left !important;
            color: #64748b;
            font-size: 10px;
        }

        /* Value Colors */
        .val-safe {
            color: var(--success-color);
            font-weight: 600;
        }

        .val-unsafe {
            color: var(--danger-color);
            font-weight: 600;
        }

        .val-warning {
            color: var(--warning-color);
            font-weight: 600;
        }

        .val-rebar {
            background-color: #fef3c7 !important;
            font-weight: 600;
            color: #92400e;
            font-family: 'Consolas', monospace;
        }

        .font-bold {
            font-weight: 600;
        }

        .txt-combo {
            font-style: italic;
            color: #64748b;
            font-size: 10px;
        }

        .txt-location {
            font-family: 'Consolas', monospace;
            color: #64748b;
            font-size: 10px;
        }

        /* Excel-like selection */
        .cell-selected {
            outline: 2px solid #1a73e8 !important;
            outline-offset: -2px;
            background-color: #e8f0fe !important;
            z-index: 10;
            position: relative;
        }

        #reportTable td {
            cursor: cell;
            user-select: text;
        }

        .cat-cell,
        .item-cell {
            background: #f8f9fa;
        }

        /* Mode Visibility */
        .mode-simple .col-detailed {
            display: none !important;
        }

        .mode-detailed .col-simple {
            display: none !important;
        }

        .mode-simple .col-simple {
            display: table-cell !important;
        }

        .mode-detailed .col-detailed {
            display: table-cell !important;
        }

        /* Result row */
        .result-row td {
            background: #f0fdf4 !important;
            font-weight: 600;
            font-size: 12px;
        }

        .btn-export {
            background-color: #217346;
            color: white;
            border: none;
            padding: 5px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: background 0.2s;
        }

        .btn-export:hover {
            background-color: #1e6b41;
        }

        .btn-export svg {
            width: 12px;
            height: 12px;
            fill: currentColor;
        }
    </style>
</head>

<body class="mode-detailed">
    <div class="sidebar compact" id="sidebar">
        <div class="sidebar-header">
            <span>Danh sách Tiết diện</span>
            <button class="sidebar-toggle" onclick="toggleSidebar()" title="Mở rộng">▶</button>
        </div>
        <ul class="group-list" id="groupList"></ul>
    </div>

    <div class="main-content">
        <div class="top-bar">
            <div class="top-bar-left">
                <button class="sidebar-expand-btn" onclick="toggleSidebar()" title="Mở sidebar">☰</button>
                <div class="report-title" style="display: none;">
                    <h2>Thuyết minh: <span id="lblGroupName">---</span>
                        <small id="lblProjectName"
                            style="font-weight: normal; color: #888; margin-left:8px; font-size:11px;"></small>
                    </h2>
                </div>
            </div>

            <div class="view-controls">
                <div class="zoom-controls">
                    <button class="zoom-btn" onclick="zoomOut()" title="Thu nhỏ">−</button>
                    <span class="zoom-label" id="zoomLabel">100%</span>
                    <button class="zoom-btn" onclick="zoomIn()" title="Phóng to">+</button>
                    <button class="zoom-btn" onclick="refreshData()" title="Làm mới dữ liệu từ XData">⟲</button>
                </div>

                <div class="switch-wrapper">
                    <span>Chi tiết</span>
                    <label class="switch">
                        <input type="checkbox" id="modeSwitch" onchange="toggleMode()">
                        <span class="slider"></span>
                    </label>
                    <span>Rút gọn</span>
                </div>

                <button class="btn-export" onclick="exportExcel()">
                    <svg viewBox="0 0 24 24">
                        <path
                            d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z" />
                    </svg>
                    Xuất Excel
                </button>
            </div>
        </div>

        <div class="span-tabs" id="spanTabs"></div>

        <div class="data-container">
            <div class="span-info-panel" id="spanInfoPanel"></div>
            <div class="table-wrapper">
                <table class="calc-table" id="reportTable">
                    <thead>
                        <tr>
                            <th style="width: 70px;">Group</th>
                            <th style="width: 100px;">Design Items</th>
                            <th style="width: 80px;">Sub-item</th>
                            <th class="col-detailed" style="width: 90px;">L1 (Left)</th>
                            <th class="col-detailed" style="width: 90px;">Center</th>
                            <th class="col-detailed" style="width: 90px;">L2 (Right)</th>
                            <th class="col-simple" style="width: 120px;">End (Envelope)</th>
                            <th class="col-simple" style="width: 120px;">Center</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // --- STATE ---
        let reportData = [];
        let currentGroupIndex = 0;
        let currentSpanIndex = 0;
        let zoomLevel = 100;

        // --- SAFE DATA ACCESS HELPERS ---
        function safe(obj, path, def = '-') {
            if (!obj) return def;
            const keys = path.split('.');
            let val = obj;
            for (const k of keys) {
                if (val == null) return def;
                val = val[k];
            }
            return val ?? def;
        }

        function safeNum(obj, path, decimals = 2) {
            const val = safe(obj, path, null);
            if (val === null || val === undefined || val === '') return '-';
            const num = parseFloat(val);
            if (isNaN(num)) return '-';
            return num.toFixed(decimals);
        }

        // --- INIT ---
        function initReport(data) {
            try {
                if (typeof data === 'string') reportData = JSON.parse(data);
                else if (Array.isArray(data)) reportData = data;
                else if (data && typeof data === 'object') reportData = [data];
                else reportData = [];
            } catch (e) {
                console.error('initReport parse error:', e);
                reportData = [];
            }

            if (reportData.length > 0) {
                renderGroupList();
                selectGroup(0);
            } else {
                document.getElementById('tableBody').innerHTML =
                    '<tr><td colspan="8" style="text-align:center;padding:20px;color:#999;">Không có dữ liệu</td></tr>';
            }
        }

        function renderGroupList() {
            const list = document.getElementById('groupList');
            list.innerHTML = '';
            reportData.forEach((group, index) => {
                const li = document.createElement('li');
                li.className = 'group-item' + (index === currentGroupIndex ? ' active' : '');

                // Extract dimensions from first span (e.g. 400x600 -> 40x60)
                let dims = '';
                const firstSpan = group.Spans?.[0];
                if (firstSpan && firstSpan.Section) {
                    dims = firstSpan.Section.replace(/(\d+)x(\d+)/, (m, w, h) => {
                        return (parseInt(w) / 10) + 'x' + (parseInt(h) / 10);
                    });
                }

                li.innerHTML = `
                    <div class="section-name">${group.GroupName || 'Group ' + (index + 1)}</div>
                    <div class="section-dims">${dims}</div>
                    <div class="section-count">Gồm ${(group.Spans || []).length} nhịp</div>
                `;
                li.onclick = () => selectGroup(index);
                list.appendChild(li);
            });
        }

        function selectGroup(index) {
            currentGroupIndex = index;
            const group = reportData[index] || {};

            // [MASTER TAB] Tạo nhịp tổng hợp (Envelope) nếu chưa có
            if (group.Spans && group.Spans.length > 0 && !group.Spans[0].isMaster) {
                const master = createMasterSpan(group.Spans);
                if (master) group.Spans.unshift(master);
            }

            document.getElementById('lblGroupName').textContent = group.GroupName || '---';
            document.getElementById('lblProjectName').textContent = group.ProjectName || '';

            document.querySelectorAll('.group-item').forEach((item, i) => {
                item.classList.toggle('active', i === index);
            });

            renderSpanTabs();
            selectSpan(0); // Luôn chọn Tab Tổng hợp đầu tiên khi đổi nhóm
        }

        function createMasterSpan(spans) {
            if (!spans || spans.length === 0) return null;

            // Clone nhịp đầu tiên làm template
            const master = JSON.parse(JSON.stringify(spans[0]));
            master.SpanId = "TỔNG HỢP(MAX)";
            master.isMaster = true;
            master.Section = "---";
            master.Length = "---";

            const stations = ['Left', 'Mid', 'Right'];
            const results = ['TopResult', 'BotResult', 'StirrupResult', 'WebResult', 'AlResult', 'StirrupOnlyResult', 'ShearResult'];

            stations.forEach(st => {
                results.forEach(res => {
                    let maxAsCalc = -1;
                    let criticalSpan = spans[0];

                    spans.forEach(s => {
                        const val = s[st] && s[st][res] ? parseFloat(s[st][res].AsCalc) || 0 : 0;
                        if (val > maxAsCalc) {
                            maxAsCalc = val;
                            criticalSpan = s;
                        }
                    });

                    if (master[st] && master[st][res]) {
                        const critRes = criticalSpan[st] ? criticalSpan[st][res] : null;
                        if (critRes) {
                            master[st][res] = JSON.parse(JSON.stringify(critRes));
                        }
                    }
                });

                // Legs lấy theo StirrupResult
                let maxStirAs = -1;
                let critStirSpan = spans[0];
                spans.forEach(s => {
                    const val = s[st] && s[st].StirrupResult ? parseFloat(s[st].StirrupResult.AsCalc) || 0 : 0;
                    if (val > maxStirAs) {
                        maxStirAs = val;
                        critStirSpan = s;
                    }
                });
                master[st].Legs = critStirSpan[st].Legs;
                master[st].LoadCase = critStirSpan[st].LoadCase;
                master[st].ElementId = "VARIES";
            });

            return master;
        }

        function renderSpanTabs() {
            const group = reportData[currentGroupIndex] || {};
            const spans = group.Spans || [];
            const tabsContainer = document.getElementById('spanTabs');
            tabsContainer.innerHTML = '';

            spans.forEach((span, index) => {
                const btn = document.createElement('button');
                btn.className = 'tab-btn' + (span.isMaster ? ' master' : '');
                btn.textContent = span.SpanId || `S${index + 1}`;
                btn.onclick = () => selectSpan(index);
                tabsContainer.appendChild(btn);
            });
        }

        function selectSpan(index) {
            currentSpanIndex = index;
            const group = reportData[currentGroupIndex] || {};
            const spans = group.Spans || [];
            if (spans.length === 0) {
                document.getElementById('spanInfoPanel').innerHTML = '<span style="color:#999;">Không có nhịp</span>';
                document.getElementById('tableBody').innerHTML = '';
                return;
            }

            const span = spans[index] || {};

            document.querySelectorAll('.tab-btn').forEach((tab, i) => {
                tab.classList.toggle('active', i === index);
            });

            // Update info panel - HIDDEN per user request
            const infoPanel = document.getElementById('spanInfoPanel');
            infoPanel.style.display = 'none';

            renderTable();
        }

        function renderTable() {
            const group = reportData[currentGroupIndex] || {};
            const spans = group.Spans || [];
            if (spans.length === 0) return;

            const span = spans[currentSpanIndex] || {};
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            const l = span.Left || {};
            const m = span.Mid || {};
            const r = span.Right || {};

            // Helper to build row
            const rRow = (cat, item, sub, vL, vM, vR, opts = {}) => {
                const style = (val) => {
                    if (opts.type === 'rebar') return 'val-rebar';
                    if (opts.type === 'combo') return 'txt-combo';
                    if (opts.type === 'loc') return 'txt-location';
                    if (opts.type === 'res') {
                        if (val === 'OK') return 'val-safe';
                        if (val === 'NG') return 'val-unsafe';
                        const num = parseFloat(val);
                        if (!isNaN(num)) return num >= 0.95 ? 'val-safe' : 'val-unsafe';
                    }
                    return '';
                };

                const formatVal = (v) => {
                    if (v === undefined || v === null || v === '' || v === '-') return '-';
                    if (opts.type === 'rebar' || opts.type === 'combo' || opts.type === 'loc') return v;
                    if (typeof v === 'number') return v.toFixed(opts.precision ?? 2);
                    return v;
                };

                // Envelope logic for Simple Mode
                // sideMax: 0=Left, 1=Right (Determined by AsCalc of current Design Item)
                let vE = '-';
                if (opts.sideMax === 1) vE = vR;
                else vE = vL;

                // For AsCalc row itself, we can show Max specifically if we want, 
                // but usually engineering rule is to show data of the critical section.
                if (opts.isAsCalc) {
                    const nL = parseFloat(vL) || 0;
                    const nR = parseFloat(vR) || 0;
                    vE = Math.max(nL, nR);
                }

                return `
                    <tr data-row-cat="${cat ? cat.text : ''}" data-row-sub="${sub}">
                        ${cat ? `<td rowspan="${cat.rowspan}" class="cat-cell" onclick="handleCellClick(this)">${cat.text}</td>` : ''}
                        ${item ? `<td rowspan="${item.rowspan}" class="item-cell" onclick="handleCellClick(this)">${item.text}</td>` : ''}
                        <td class="sub-cell" onclick="handleCellClick(this)">${sub}</td>
                        <td class="col-detailed ${style(vL)}" onclick="handleCellClick(this)">${formatVal(vL)}</td>
                        <td class="col-detailed ${style(vM)}" onclick="handleCellClick(this)">${formatVal(vM)}</td>
                        <td class="col-detailed ${style(vR)}" onclick="handleCellClick(this)">${formatVal(vR)}</td>
                        <td class="col-simple ${style(vE)}" onclick="handleCellClick(this)">${formatVal(vE)}</td>
                        <td class="col-simple ${style(vM)}" onclick="handleCellClick(this)">${formatVal(vM)}</td>
                    </tr>
                `;
            };

            const cleanStirrupStr = (str) => {
                if (!str || str === '-') return '-';
                // This regex matches "2-d10a150" and extracts "d10a150"
                const match = str.match(/(\d+[-])?(.+)/);
                return match ? match[2] : str;
            };

            // --- BY SAP2000 BLOCK --- (10 rows)
            const sMaxTop = (parseFloat(safe(l, 'TopResult.AsCalc')) || 0) >= (parseFloat(safe(r, 'TopResult.AsCalc')) || 0) ? 0 : 1;
            tbody.innerHTML += rRow({ text: 'By SAP2000', rowspan: 10 }, { text: 'As, top (mm²)', rowspan: 3 }, 'Demand req.',
                safe(l, 'TopResult.AsCalc'), safe(m, 'TopResult.AsCalc'), safe(r, 'TopResult.AsCalc'), { isAsCalc: true });
            tbody.innerHTML += rRow(null, null, 'Element (LC)',
                safe(l, 'TopResult.ElementId'), safe(m, 'TopResult.ElementId'), safe(r, 'TopResult.ElementId'), { type: 'combo', sideMax: sMaxTop });
            tbody.innerHTML += rRow(null, null, 'Location (mm)',
                safe(l, 'TopResult.LocationMm'), safe(m, 'TopResult.LocationMm'), safe(r, 'TopResult.LocationMm'), { type: 'loc', sideMax: sMaxTop });

            const sMaxBot = (parseFloat(safe(l, 'BotResult.AsCalc')) || 0) >= (parseFloat(safe(r, 'BotResult.AsCalc')) || 0) ? 0 : 1;
            tbody.innerHTML += rRow(null, { text: 'As, bot (mm²)', rowspan: 3 }, 'Demand req.',
                safe(l, 'BotResult.AsCalc'), safe(m, 'BotResult.AsCalc'), safe(r, 'BotResult.AsCalc'), { isAsCalc: true });
            tbody.innerHTML += rRow(null, null, 'Element (LC)',
                safe(l, 'BotResult.ElementId'), safe(m, 'BotResult.ElementId'), safe(r, 'BotResult.ElementId'), { type: 'combo', sideMax: sMaxBot });
            tbody.innerHTML += rRow(null, null, 'Location (mm)',
                safe(l, 'BotResult.LocationMm'), safe(m, 'BotResult.LocationMm'), safe(r, 'BotResult.LocationMm'), { type: 'loc', sideMax: sMaxBot });

            const sMaxStir = (parseFloat(safe(l, 'StirrupResult.AsCalc')) || 0) >= (parseFloat(safe(r, 'StirrupResult.AsCalc')) || 0) ? 0 : 1;
            tbody.innerHTML += rRow(null, { text: '2At/st + Av/sv', rowspan: 2 }, 'mm²/mm',
                safe(l, 'StirrupResult.AsCalc'), safe(m, 'StirrupResult.AsCalc'), safe(r, 'StirrupResult.AsCalc'), { isAsCalc: true });
            tbody.innerHTML += rRow(null, null, 'Element (LC)',
                safe(l, 'StirrupResult.LoadCase'), safe(m, 'StirrupResult.LoadCase'), safe(r, 'StirrupResult.LoadCase'), { type: 'combo', sideMax: sMaxStir });

            // Hide redundant torsion/shear check rows as requested
            /*
            tbody.innerHTML += rRow(null, { text: '2At/sv', rowspan: 2 }, 'mm²/mm (Torsion)',
                safe(l, 'StirrupOnlyResult.AsCalc'), safe(m, 'StirrupOnlyResult.AsCalc'), safe(r, 'StirrupOnlyResult.AsCalc'));
            tbody.innerHTML += rRow(null, null, 'Element (LC)',
                safe(l, 'StirrupOnlyResult.LoadCase'), safe(m, 'StirrupOnlyResult.LoadCase'), safe(r, 'StirrupOnlyResult.LoadCase'), { type: 'combo' });

            tbody.innerHTML += rRow(null, { text: 'Av/sv', rowspan: 2 }, 'mm²/mm (Shear Only)',
                safe(l, 'ShearResult.AsCalc'), safe(m, 'ShearResult.AsCalc'), safe(r, 'ShearResult.AsCalc'));
            tbody.innerHTML += rRow(null, null, 'Element (LC)',
                safe(l, 'ShearResult.LoadCase'), safe(m, 'ShearResult.LoadCase'), safe(r, 'ShearResult.LoadCase'), { type: 'combo' });
            */

            const sMaxAl = (parseFloat(safe(l, 'AlResult.AsCalc')) || 0) >= (parseFloat(safe(r, 'AlResult.AsCalc')) || 0) ? 0 : 1;
            tbody.innerHTML += rRow(null, { text: 'Al (mm²)', rowspan: 2 }, 'Torsion Long.',
                safe(l, 'AlResult.AsCalc'), safe(m, 'AlResult.AsCalc'), safe(r, 'AlResult.AsCalc'), { isAsCalc: true });
            tbody.innerHTML += rRow(null, null, 'Element (LC)',
                safe(l, 'AlResult.LoadCase'), safe(m, 'AlResult.LoadCase'), safe(r, 'AlResult.LoadCase'), { type: 'combo', sideMax: sMaxAl });

            tbody.innerHTML += '<tr class="row-separator"><td colspan="7"></td></tr>';

            // --- FINAL USE BLOCK --- (12 rows)
            tbody.innerHTML += rRow({ text: 'Final Use', rowspan: 12 }, { text: 'Top bar', rowspan: 3 }, 'Rebar config',
                safe(l, 'TopResult.RebarStr'), safe(m, 'TopResult.RebarStr'), safe(r, 'TopResult.RebarStr'), { type: 'rebar', sideMax: sMaxTop });
            tbody.innerHTML += rRow(null, null, 'Provide (mm²)',
                safe(l, 'TopResult.AsProv'), safe(m, 'TopResult.AsProv'), safe(r, 'TopResult.AsProv'), { isAsCalc: true });
            tbody.innerHTML += rRow(null, null, 'Ratio / Check',
                safe(l, 'TopResult.Ratio'), safe(m, 'TopResult.Ratio'), safe(r, 'TopResult.Ratio'), { type: 'res', sideMax: sMaxTop });

            tbody.innerHTML += rRow(null, { text: 'Bottom bar', rowspan: 3 }, 'Rebar config',
                safe(l, 'BotResult.RebarStr'), safe(m, 'BotResult.RebarStr'), safe(r, 'BotResult.RebarStr'), { type: 'rebar', sideMax: sMaxBot });
            tbody.innerHTML += rRow(null, null, 'Provide (mm²)',
                safe(l, 'BotResult.AsProv'), safe(m, 'BotResult.AsProv'), safe(r, 'BotResult.AsProv'), { isAsCalc: true });
            tbody.innerHTML += rRow(null, null, 'Ratio / Check',
                safe(l, 'BotResult.Ratio'), safe(m, 'BotResult.Ratio'), safe(r, 'BotResult.Ratio'), { type: 'res', sideMax: sMaxBot });

            tbody.innerHTML += rRow(null, { text: 'Stirrup', rowspan: 3 }, 'a) No. Leg',
                safe(l, 'Legs'), safe(m, 'Legs'), safe(r, 'Legs'), { type: 'rebar', sideMax: sMaxStir });
            tbody.innerHTML += rRow(null, null, 'b) Rebar',
                cleanStirrupStr(safe(l, 'StirrupResult.RebarStr')), cleanStirrupStr(safe(m, 'StirrupResult.RebarStr')), cleanStirrupStr(safe(r, 'StirrupResult.RebarStr')), { type: 'rebar', sideMax: sMaxStir });
            tbody.innerHTML += rRow(null, null, 'c) Check 2At/st + Av/sv',
                safe(l, 'StirrupResult.AsProv'), safe(m, 'StirrupResult.AsProv'), safe(r, 'StirrupResult.AsProv'), { precision: 3, type: 'res', sideMax: sMaxStir });

            // Hide redundant stirrup check rows as requested
            /*
            tbody.innerHTML += rRow(null, null, 'Ref SAP demand',
                safe(l, 'StirrupResult.AsCalc'), safe(m, 'StirrupResult.AsCalc'), safe(r, 'StirrupResult.AsCalc'), { precision: 3, type: 'loc' });
            tbody.innerHTML += rRow(null, null, 'd) Check 2At/sv',
                safe(l, 'StirrupOnlyResult.AsProv'), safe(m, 'StirrupOnlyResult.AsProv'), safe(r, 'StirrupOnlyResult.AsProv'), { precision: 3, type: 'res' });
            tbody.innerHTML += rRow(null, null, 'Ref SAP demand',
                safe(l, 'StirrupOnlyResult.AsCalc'), safe(m, 'StirrupOnlyResult.AsCalc'), safe(r, 'StirrupOnlyResult.AsCalc'), { precision: 3, type: 'loc' });
            */

            tbody.innerHTML += rRow(null, { text: 'Web bar', rowspan: 3 }, 'Rebar config',
                safe(l, 'WebResult.RebarStr'), safe(m, 'WebResult.RebarStr'), safe(r, 'WebResult.RebarStr'), { type: 'rebar', sideMax: sMaxAl });
            tbody.innerHTML += rRow(null, null, 'Provide (mm²)',
                safe(l, 'WebResult.AsProv'), safe(m, 'WebResult.AsProv'), safe(r, 'WebResult.AsProv'), { isAsCalc: true });
            tbody.innerHTML += rRow(null, null, 'Ratio / Check',
                safe(l, 'AlResult.Ratio'), safe(m, 'AlResult.Ratio'), safe(r, 'AlResult.Ratio'), { type: 'res', sideMax: sMaxAl });
        }

        // --- UTILITIES ---
        function toggleMode() {
            const isSimple = document.getElementById('modeSwitch').checked;
            document.body.className = isSimple ? 'mode-simple' : 'mode-detailed';
            renderTable();
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const toggleBtn = document.querySelector('.sidebar-toggle');
            sidebar.classList.toggle('compact');

            if (sidebar.classList.contains('compact')) {
                toggleBtn.textContent = '▶';
                toggleBtn.title = 'Mở rộng';
            } else {
                toggleBtn.textContent = '◀';
                toggleBtn.title = 'Thu gọn';
            }
        }

        function zoomIn() {
            if (zoomLevel < 150) {
                zoomLevel += 10;
                applyZoom();
            }
        }

        function zoomOut() {
            if (zoomLevel > 50) {
                zoomLevel -= 10;
                applyZoom();
            }
        }

        function applyZoom() {
            document.getElementById('zoomLabel').textContent = zoomLevel + '%';
            const table = document.getElementById('reportTable');
            const scale = zoomLevel / 100;
            table.style.transform = `scale(${scale})`;

            // Adjust width to compensate for scaling so the container scrollbars work correctly
            table.style.width = (100 / scale) + '%';
        }

        // --- EXCEL-LIKE INTERACTION ---
        let activeCell = null;

        function handleCellClick(td) {
            if (activeCell) activeCell.classList.remove('cell-selected');
            activeCell = td;
            activeCell.classList.add('cell-selected');
            activeCell.focus();
        }

        document.addEventListener('keydown', (e) => {
            if (!activeCell) return;

            const key = e.key;
            if (key === 'ArrowUp' || key === 'ArrowDown' || key === 'ArrowLeft' || key === 'ArrowRight') {
                e.preventDefault();
                moveSelection(key);
            } else if (e.ctrlKey && key === 'c') {
                copyToClipboard(activeCell.innerText);
            }
        });

        function moveSelection(key) {
            const tr = activeCell.parentElement;
            const cells = Array.from(tr.querySelectorAll('td'));
            let colIdx = cells.indexOf(activeCell);

            // Adjust colIdx for rowspan if needed (simplification: just find by bounding box)
            const rect = activeCell.getBoundingClientRect();
            let targetX = rect.left + rect.width / 2;
            let targetY = rect.top + rect.height / 2;

            if (key === 'ArrowUp') targetY -= rect.height;
            if (key === 'ArrowDown') targetY += rect.height;
            if (key === 'ArrowLeft') targetX -= rect.width;
            if (key === 'ArrowRight') targetX += rect.width;

            const targetElement = document.elementFromPoint(targetX, targetY);
            if (targetElement && targetElement.tagName === 'TD') {
                handleCellClick(targetElement);
            }
        }

        function copyToClipboard(text) {
            const el = document.createElement('textarea');
            el.value = text;
            document.body.appendChild(el);
            el.select();
            document.execCommand('copy');
            document.body.removeChild(el);

            // Small visual feedback? 
            // activeCell.style.backgroundColor = '#c8e6c9';
            // setTimeout(() => activeCell.style.backgroundColor = '', 200);
        }

        function refreshData() {
            if (window.chrome && window.chrome.webview) {
                window.chrome.webview.postMessage({
                    command: 'refresh_data'
                });
            }
        }

        function exportExcel() {
            const isSimple = document.body.classList.contains('mode-simple');
            const group = reportData[currentGroupIndex] || null;
            if (!group) {
                alert('Không có dữ liệu để xuất');
                return;
            }
            // Post message to C# - object will be received via WebMessageAsJson
            if (window.chrome && window.chrome.webview) {
                window.chrome.webview.postMessage({
                    command: 'export_excel',
                    data: group,
                    isSimple: isSimple
                });
            }
        }
    </script>
</body>

</html>