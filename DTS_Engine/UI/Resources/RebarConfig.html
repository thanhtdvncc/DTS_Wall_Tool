<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background: #f5f5f5;
            margin: 0;
            padding: 0;
            color: #333;
            font-size: 13px;
            user-select: none;
        }

        .header {
            background: linear-gradient(135deg, #0d6efd, #0a58ca);
            color: #fff;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h2 {
            margin: 0;
            font-size: 15px;
        }

        .badge {
            background: rgba(255, 255, 255, .2);
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 11px;
        }

        .tabs {
            display: flex;
            background: #fff;
            border-bottom: 1px solid #dee2e6;
        }

        .tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            font-weight: 500;
            color: #6c757d;
            font-size: 12px;
        }

        .tab:hover {
            background: #f8f9fa;
        }

        .tab.active {
            color: #0d6efd;
            border-bottom-color: #0d6efd;
        }

        .content {
            padding: 15px;
            height: 440px;
            overflow-y: auto;
        }

        .tab-panel {
            display: none;
        }

        .tab-panel.active {
            display: block;
        }

        .section {
            background: #fff;
            border-radius: 6px;
            margin-bottom: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, .08);
        }

        .section-header {
            padding: 8px 12px;
            font-weight: 600;
            color: #495057;
            font-size: 12px;
            border-bottom: 1px solid #f0f0f0;
        }

        .section-body {
            padding: 12px;
        }

        .row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .row:last-child {
            margin-bottom: 0;
        }

        .col {
            flex: 1;
        }

        .col-2 {
            flex: 2;
        }

        label {
            display: block;
            font-size: 11px;
            color: #6c757d;
            margin-bottom: 4px;
        }

        input[type='text'],
        input[type='number'] {
            width: 100%;
            padding: 7px 10px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 12px;
        }

        input:focus {
            border-color: #86b7fe;
            outline: none;
            box-shadow: 0 0 0 2px rgba(13, 110, 253, .15);
        }

        .check-row {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px 0;
        }

        .check-row input[type='checkbox'] {
            width: 16px;
            height: 16px;
            accent-color: #0d6efd;
        }

        .check-row label {
            margin: 0;
            font-size: 12px;
            color: #333;
        }

        .hint {
            font-size: 10px;
            color: #adb5bd;
            margin-top: 3px;
        }

        .diameter-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .diameter-chip {
            padding: 6px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            background: #f8f9fa;
            transition: 0.2s;
        }

        .diameter-chip:hover {
            background: #e9ecef;
        }

        .diameter-chip.active {
            background: #0d6efd;
            color: #fff;
            border-color: #0d6efd;
        }

        .corner-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
            width: 120px;
        }

        .corner-btn {
            padding: 10px 8px;
            text-align: center;
            border: 1px solid #ced4da;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 500;
            background: #f8f9fa;
            transition: 0.2s;
        }

        .corner-btn:hover {
            background: #e9ecef;
        }

        .corner-btn.active {
            background: #0d6efd;
            color: #fff;
            border-color: #0d6efd;
        }

        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .radio-label {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            cursor: pointer;
        }

        .radio-label input {
            accent-color: #0d6efd;
        }

        .footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #fff;
            padding: 12px 20px;
            border-top: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .footer-left {
            display: flex;
            gap: 8px;
        }

        .footer-right {
            display: flex;
            gap: 10px;
        }

        button {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            font-weight: 600;
            font-size: 12px;
            cursor: pointer;
        }

        .btn-primary {
            background: #0d6efd;
            color: #fff;
        }

        .btn-primary:hover {
            background: #0b5ed7;
        }

        .btn-secondary {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
        }

        .btn-secondary:hover {
            background: #e9ecef;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 11px;
        }
    </style>
</head>

<body>
    <div class="header">
        <h2>DTS Rebar Configuration</h2>
        <span class="badge">v2.0</span>
    </div>

    <div class="tabs">
        <div class="tab active" onclick="showTab(0)">General</div>
        <div class="tab" onclick="showTab(1)">Beam</div>
        <div class="tab" onclick="showTab(2)">Column</div>
        <div class="tab" onclick="showTab(3)">Naming</div>
        <div class="tab" onclick="showTab(4)">Neo & Nối</div>
        <div class="tab" onclick="showTab(5)">Bố trí</div>
    </div>

    <div class="content">
        <!-- TAB 0: GENERAL -->
        <div class="tab-panel active" id="tab0">
            <div class="section">
                <div class="section-header">Kho thép chuẩn (Inventory)</div>
                <div class="section-body">
                    <div class="diameter-grid" id="inventoryGrid"></div>
                    <div class="hint">Click để bật/tắt đường kính. Các đường kính được chọn sẽ khả dụng cho tính toán.
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-header">Đoạn xét nội lực (Analysis Zones)</div>
                <div class="section-body">
                    <div class="row">
                        <div class="col"><label>Zone L1 (đầu nhịp)</label><input type="number" id="ZoneL1_Ratio"
                                step="0.05" min="0" max="0.5"></div>
                        <div class="col"><label>Zone L2 (cuối nhịp)</label><input type="number" id="ZoneL2_Ratio"
                                step="0.05" min="0" max="0.5"></div>
                        <div class="col"><label>Đơn vị</label>
                            <select id="Unit"
                                style="width:100%;padding:7px;border:1px solid #ced4da;border-radius:4px;font-size:12px;">
                                <option value="mm">mm</option>
                                <option value="cm">cm</option>
                                <option value="m">m</option>
                            </select>
                        </div>
                    </div>
                    <div class="hint">Zone = tỉ lệ nhịp để lấy Momen/Lực cắt lớn nhất. VD: 0.25 = 1/4 nhịp.</div>
                </div>
            </div>

            <div class="section">
                <div class="section-header">Cài đặt Text Label</div>
                <div class="section-body">
                    <div class="row">
                        <div class="col"><label>Chiều cao Text</label><input type="number" id="TextHeight" value="1"
                                step="0.1" min="0.1" max="10"></div>
                        <div class="col"></div>
                        <div class="col"></div>
                    </div>
                    <div class="hint">Chiều cao text khi vẽ label thép (mặc định = 1). Điều chỉnh theo tỷ lệ bản vẽ.
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-header">Import / Export Settings</div>
                <div class="section-body">
                    <div class="row">
                        <div class="col">
                            <button class="btn-secondary btn-sm" onclick="doImport()">Import</button>
                            <button class="btn-secondary btn-sm" onclick="doExport()">Export</button>
                        </div>
                    </div>
                    <div class="hint">Lưu/tải cấu hình để chia sẻ hoặc dùng cho dự án khác (.dtss)</div>
                </div>
            </div>
        </div>

        <!-- TAB 1: BEAM -->
        <div class="tab-panel" id="tab1">
            <div class="section">
                <div class="section-header">Phạm vi thép (Rebar Selection)</div>
                <div class="section-body">
                    <div class="row">
                        <div class="col"><label>Thép chủ (Main)</label><input type="text" id="MainBarRange"
                                placeholder="16-25"></div>
                        <div class="col"><label>Thép đai (Stirrup)</label><input type="text" id="StirrupBarRange"
                                placeholder="8-10"></div>
                        <div class="col"><label>Thép hông (Side)</label><input type="text" id="SideBarRange"
                                placeholder="12-14"></div>
                    </div>
                    <div class="hint">Nhập khoảng: "16-25" hoặc liệt kê: "18, 20, 22". Sẽ lọc theo Kho thép ở tab
                        General.</div>
                </div>
            </div>

            <div class="section">
                <div class="section-header">Lớp bảo vệ (mm)</div>
                <div class="section-body">
                    <div class="row">
                        <div class="col"><label>Cover Top</label><input type="number" id="CoverTop"></div>
                        <div class="col"><label>Cover Bot</label><input type="number" id="CoverBot"></div>
                        <div class="col"><label>Cover Side</label><input type="number" id="CoverSide"></div>
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-header">Khoảng hở cốt thép (Clear Spacing)</div>
                <div class="section-body">
                    <div class="check-row">
                        <input type="checkbox" id="UseBarDiameterForSpacing">
                        <label for="UseBarDiameterForSpacing">Khoảng hở tối thiểu theo đường kính thép</label>
                    </div>
                    <div class="row">
                        <div class="col"><label>Hệ số x đường kính</label><input type="number"
                                id="BarDiameterSpacingMultiplier" step="0.1" min="1" max="3"></div>
                        <div class="col"><label>Min Spacing cố định (mm)</label><input type="number"
                                id="MinClearSpacing"></div>
                        <div class="col"><label>Max Spacing (mm)</label><input type="number" id="MaxClearSpacing"></div>
                    </div>
                    <div class="hint">Nếu bật: spacing ≥ N × d_max. Nếu tắt: dùng Min Spacing cố định. Theo ACI/TCVN
                        thường ≥ 1.0d.</div>
                </div>
            </div>

            <div class="section">
                <div class="section-header">Hệ số phân bổ thép xoắn (Torsion Distribution)</div>
                <div class="section-body">
                    <div class="row">
                        <div class="col"><label>Top Bar</label><input type="number" id="TorsionDist_TopBar" step="0.01">
                        </div>
                        <div class="col"><label>Bot Bar</label><input type="number" id="TorsionDist_BotBar" step="0.01">
                        </div>
                        <div class="col"><label>Side Bar</label><input type="number" id="TorsionDist_SideBar"
                                step="0.01"></div>
                    </div>
                    <div class="hint">Tổng = 1.0. VD: TopBar=0.16, BotBar=0.16, SideBar=0.68</div>
                </div>
            </div>

            <div class="section">
                <div class="section-header">Bố trí thép tự động (Auto Arrangement)</div>
                <div class="section-body">
                    <div class="row">
                        <div class="col"><label>Số lớp tối đa</label><input type="number" id="MaxLayers" min="1"
                                max="5"></div>
                        <div class="col"><label>Min thanh/lớp</label><input type="number" id="MinBarsPerLayer" min="2"
                                max="10"></div>
                        <div class="col"><label>H min thép sườn (mm)</label><input type="number" id="WebBarMinHeight">
                        </div>
                    </div>
                    <div class="check-row"><input type="checkbox" id="PreferSingleDiameter"><label
                            for="PreferSingleDiameter">Ưu tiên cùng 1 đường kính (các lớp)</label></div>
                    <div class="check-row"><input type="checkbox" id="PreferSymmetric"><label for="PreferSymmetric">Ưu
                            tiên bố trí đối xứng</label></div>
                    <div class="check-row"><input type="checkbox" id="PreferFewerBars"><label for="PreferFewerBars">Ưu
                            tiên ít thanh hơn (đường kính lớn)</label></div>
                    <div class="check-row"><input type="checkbox" id="PreferEvenDiameter"><label
                            for="PreferEvenDiameter">Ưu tiên đường kính chẵn</label></div>
                </div>
            </div>

            <div class="section">
                <div class="section-header">Thép đai nâng cao</div>
                <div class="section-body">
                    <div class="row">
                        <div class="col"><label>μ_min</label><input type="number" id="MinReinforcementRatio"
                                step="0.001"></div>
                        <div class="col-2"><label>Auto Legs Rules</label><input type="text" id="AutoLegsRules"
                                placeholder="250-2 400-3 600-4"></div>
                    </div>
                    <div class="check-row"><input type="checkbox" id="AllowOddLegs"><label for="AllowOddLegs">Cho phép
                            nhánh đai lẻ (3, 5...)</label></div>
                    <div class="hint">Auto Legs: b≤250→2 nhánh, b≤400→3 nhánh...</div>
                </div>
            </div>

            <div class="section">
                <div class="section-header">Quy tắc dầm liên tục (Continuous Beam)</div>
                <div class="section-body">
                    <div class="check-row"><input type="checkbox" id="ForceContinuousDiameter" checked><label
                            for="ForceContinuousDiameter">Đồng bộ đường kính chạy suốt (Layer 1)</label></div>
                    <div class="check-row"><input type="checkbox" id="SingleDiameterPerSpan" checked><label
                            for="SingleDiameterPerSpan">Một loại đường kính/mặt cắt</label></div>
                    <div class="check-row"><input type="checkbox" id="AllowDiameterMixing"><label
                            for="AllowDiameterMixing">Cho phép phối đường kính</label></div>
                    <div class="row">
                        <div class="col"><label>Max Diff (cấp)</label><input type="number" id="MaxDiameterDiff"
                                value="1" min="1" max="3"></div>
                        <div class="col"><label>Thép tiêu chuẩn (mm)</label><input type="number" id="StandardBarLength"
                                value="11700"></div>
                        <div class="col"><label>Nối chồng (xd)</label><input type="number" id="BeamLapSpliceMultiplier"
                                value="40"></div>
                    </div>
                    <div class="check-row"><input type="checkbox" id="MatchTopLayerBars" checked><label
                            for="MatchTopLayerBars">Khớp số thanh lớp trên (Match Top Layer)</label></div>
                    <div class="hint">Quy tắc áp dụng khi tính thép dải dầm liên tục (Girder/Beam chạy qua nhiều cột).
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB 2: COLUMN -->
        <div class="tab-panel" id="tab2">
            <div class="section">
                <div class="section-header">Phạm vi thép cột</div>
                <div class="section-body">
                    <div class="row">
                        <div class="col"><label>Thép chủ (Main)</label><input type="text" id="ColMainBarRange"
                                placeholder="16-28"></div>
                        <div class="col"><label>Thép đai (Stirrup)</label><input type="text" id="ColStirrupBarRange"
                                placeholder="8-10"></div>
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-header">Lớp bảo vệ & Quy tắc</div>
                <div class="section-body">
                    <div class="row">
                        <div class="col"><label>Cover (mm)</label><input type="number" id="ColCover"></div>
                        <div class="col"><label>Nối chồng (xd)</label><input type="number" id="LapSpliceMultiplier">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col"><label>Min thanh/cạnh</label><input type="number" id="MinBarsPerSide"></div>
                        <div class="col"><label>Max Stirrup Spacing</label><input type="number" id="MaxStirrupSpacing">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB 3: NAMING -->
        <div class="tab-panel" id="tab3">
            <div class="section">
                <div class="section-header">Tiền tố / Hậu tố</div>
                <div class="section-body">
                    <div class="row">
                        <div class="col"><label>Beam Prefix</label><input type="text" id="BeamPrefix"></div>
                        <div class="col"><label>Girder Prefix</label><input type="text" id="GirderPrefix"></div>
                        <div class="col"><label>Column Prefix</label><input type="text" id="ColumnPrefix"></div>
                        <div class="col"><label>Suffix</label><input type="text" id="BeamSuffix"></div>
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-header">Quy tắc nhóm</div>
                <div class="section-body">
                    <div class="check-row"><input type="checkbox" id="GroupByAxis"><label for="GroupByAxis">Nhóm theo
                            trục</label></div>
                    <div class="check-row"><input type="checkbox" id="MergeSameSection"><label
                            for="MergeSameSection">Gộp dầm cùng section & rebar</label></div>
                    <div class="check-row"><input type="checkbox" id="AutoRenameOnSectionChange"><label
                            for="AutoRenameOnSectionChange">Tự rename khi section đổi</label></div>
                </div>
            </div>

            <div class="section">
                <div class="section-header">Thứ tự quét (Sorting)</div>
                <div class="section-body">
                    <div class="row">
                        <div class="col">
                            <label style="margin-bottom: 8px;">Góc bắt đầu</label>
                            <div class="corner-grid">
                                <div class="corner-btn" data-corner="0">┏ TL</div>
                                <div class="corner-btn" data-corner="1">TR ┓</div>
                                <div class="corner-btn" data-corner="2">┗ BL</div>
                                <div class="corner-btn" data-corner="3">BR ┛</div>
                            </div>
                            <input type="hidden" id="SortCorner" value="0">
                        </div>
                        <div class="col">
                            <label style="margin-bottom: 8px;">Hướng ưu tiên</label>
                            <div class="radio-group">
                                <label class="radio-label"><input type="radio" name="sortDir" value="0" checked> Ngang
                                    (X)</label>
                                <label class="radio-label"><input type="radio" name="sortDir" value="1"> Dọc (Y)</label>
                            </div>
                            <input type="hidden" id="SortDirection" value="0">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB 4: ANCHORAGE (Neo & Nối) -->
        <div class="tab-panel" id="tab4">
            <div class="section">
                <div class="section-header">Vật liệu</div>
                <div class="section-body">
                    <div class="row">
                        <div class="col"><label>Mác bê tông</label>
                            <select id="ConcreteGrade">
                                <option value="B20">B20</option>
                                <option value="B25" selected>B25</option>
                                <option value="B30">B30</option>
                                <option value="B35">B35</option>
                            </select>
                        </div>
                        <div class="col"><label>Mác thép</label>
                            <select id="SteelGrade">
                                <option value="CB300V">CB300V</option>
                                <option value="CB400V" selected>CB400V</option>
                                <option value="CB500V">CB500V</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-header">Hệ số nối thép (Lap Splice)</div>
                <div class="section-body">
                    <div class="row">
                        <div class="col"><label>Vùng kéo (×d)</label><input type="number" id="TensileSpliceFactor"
                                value="40"></div>
                        <div class="col"><label>Vùng nén (×d)</label><input type="number" id="CompressiveSpliceFactor"
                                value="30"></div>
                        <div class="col"><label>Chiều dài neo (×d)</label><input type="number" id="AnchorageFactor"
                                value="35"></div>
                    </div>
                    <div class="hint">VD: 40d = 40 x đường kính thep. Với D20: L = 40 x 20 = 800mm</div>
                </div>
            </div>

            <div class="section">
                <div class="section-header">Hệ số móc (Hooks)</div>
                <div class="section-body">
                    <div class="row">
                        <div class="col"><label>Móc 90° (×d)</label><input type="number" id="Hook90Factor" value="12">
                        </div>
                        <div class="col"><label>Móc 135° (×d)</label><input type="number" id="Hook135Factor" value="6">
                        </div>
                        <div class="col"><label>Móc 180° (×d)</label><input type="number" id="Hook180Factor" value="4">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col"><label>Chiều dài móc tối thiểu (mm)</label><input type="number"
                                id="MinHookLength" value="75"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB 5: DETAILING (Bố trí) -->
        <div class="tab-panel" id="tab5">
            <div class="section">
                <div class="section-header">Giới hạn thanh thép</div>
                <div class="section-body">
                    <div class="row">
                        <div class="col"><label>Chiều dài max (mm)</label><input type="number" id="MaxBarLength"
                                value="11700"></div>
                        <div class="col"><label>Chiều dài min (mm)</label><input type="number" id="MinBarLength"
                                value="2000"></div>
                    </div>
                    <div class="row">
                        <div class="col"><label>Khoảng so le nối (mm)</label><input type="number"
                                id="MinStaggerDistance" value="600"></div>
                        <div class="col"><label>Hệ số so le (×Ld)</label><input type="number" id="StaggerFactorLd"
                                value="1.3" step="0.1"></div>
                    </div>
                    <div class="check-row">
                        <input type="checkbox" id="SkipSplice">
                        <label for="SkipSplice"><strong>Bỏ qua nối thép</strong> (nhà cung cấp cắt theo yêu cầu)</label>
                    </div>
                    <div class="hint">Khi bật: thép được vẽ liền mạch, không hiển thị điểm nối.</div>
                </div>
            </div>

            <div class="section">
                <div class="section-header">Vùng nối thép - Dầm phụ (Beam)</div>
                <div class="section-body">
                    <div class="row">
                        <div class="col">
                            <label>Thép trên nối tại</label>
                            <select id="BeamTopSpliceZone">
                                <option value="0">Tại gối (Support)</option>
                                <option value="1">L/4</option>
                                <option value="2" selected>Giữa nhịp (Mid)</option>
                            </select>
                        </div>
                        <div class="col">
                            <label>Thép dưới nối tại</label>
                            <select id="BeamBotSpliceZone">
                                <option value="0" selected>Tại gối (Support)</option>
                                <option value="1">L/4</option>
                                <option value="2">Giữa nhịp (Mid)</option>
                            </select>
                        </div>
                    </div>
                    <div class="check-row">
                        <input type="checkbox" id="BeamAllowLapInJoint">
                        <label for="BeamAllowLapInJoint">Cho phép nối trong nút khung</label>
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-header">Vùng nối thép - Dầm chính (Girder)</div>
                <div class="section-body">
                    <div class="row">
                        <div class="col">
                            <label>Thép trên nối tại</label>
                            <select id="GirderTopSpliceZone">
                                <option value="0">Tại gối (Support)</option>
                                <option value="1" selected>L/4</option>
                                <option value="2">Giữa nhịp (Mid)</option>
                            </select>
                        </div>
                        <div class="col">
                            <label>Thép dưới nối tại</label>
                            <select id="GirderBotSpliceZone">
                                <option value="0" selected>Tại gối (Support)</option>
                                <option value="1">L/4</option>
                                <option value="2">Giữa nhịp (Mid)</option>
                            </select>
                        </div>
                    </div>
                    <div class="check-row">
                        <input type="checkbox" id="GirderAllowLapInJoint" checked>
                        <label for="GirderAllowLapInJoint">Cho phép nối trong nút khung (Neo xuyên cột)</label>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="footer">
        <div class="footer-left">
            <!-- Import/Export moved to General tab -->
        </div>
        <div class="footer-right">
            <button class="btn-secondary" onclick="doCancel()">Hủy bỏ</button>
            <button class="btn-primary" onclick="doSave()">Lưu cấu hình</button>
        </div>
    </div>

    <script>
        const data = __SETTINGS_JSON__;
        const ALL_DIAMETERS = [6, 8, 10, 12, 13, 14, 16, 18, 19, 20, 22, 25, 28, 29, 32, 36, 40];

        function showTab(idx) {
            document.querySelectorAll('.tab').forEach((t, i) => t.classList.toggle('active', i === idx));
            document.querySelectorAll('.tab-panel').forEach((p, i) => p.classList.toggle('active', i === idx));
        }

        function buildInventoryGrid() {
            const grid = document.getElementById('inventoryGrid');
            const available = data.General?.AvailableDiameters || [];
            grid.innerHTML = '';
            ALL_DIAMETERS.forEach(d => {
                const chip = document.createElement('div');
                chip.className = 'diameter-chip' + (available.includes(d) ? ' active' : '');
                chip.textContent = 'Ø' + d;
                chip.dataset.diameter = d;
                chip.onclick = () => chip.classList.toggle('active');
                grid.appendChild(chip);
            });
        }

        function getSelectedDiameters() {
            const chips = document.querySelectorAll('#inventoryGrid .diameter-chip.active');
            return Array.from(chips).map(c => parseInt(c.dataset.diameter)).sort((a, b) => a - b);
        }

        function loadForm() {
            const setId = (id, val) => { const el = document.getElementById(id); if (el) el.value = val ?? ''; };
            const setChk = (id, val) => { const el = document.getElementById(id); if (el) el.checked = val || false; };

            // Build inventory grid
            buildInventoryGrid();

            // Tab 0: General
            setId('ZoneL1_Ratio', data.General?.ZoneL1_Ratio);
            setId('ZoneL2_Ratio', data.General?.ZoneL2_Ratio);
            if (data.General?.Unit) document.getElementById('Unit').value = data.General.Unit;
            setId('TextHeight', data.General?.TextHeight ?? 1);

            // Tab 1: Beam
            setId('MainBarRange', data.Beam?.MainBarRange);
            setId('StirrupBarRange', data.Beam?.StirrupBarRange);
            setId('SideBarRange', data.Beam?.SideBarRange);
            setId('CoverTop', data.Beam?.CoverTop);
            setId('CoverBot', data.Beam?.CoverBot);
            setId('CoverSide', data.Beam?.CoverSide);
            // Clear Spacing
            setChk('UseBarDiameterForSpacing', data.Beam?.UseBarDiameterForSpacing ?? true);
            setId('BarDiameterSpacingMultiplier', data.Beam?.BarDiameterSpacingMultiplier ?? 1.0);
            setId('MinClearSpacing', data.Beam?.MinClearSpacing);
            setId('MaxClearSpacing', data.Beam?.MaxClearSpacing);
            // Torsion (new names)
            setId('TorsionDist_TopBar', data.Beam?.TorsionDist_TopBar ?? data.Beam?.TorsionDist_Top);
            setId('TorsionDist_BotBar', data.Beam?.TorsionDist_BotBar ?? data.Beam?.TorsionDist_Bot);
            setId('TorsionDist_SideBar', data.Beam?.TorsionDist_SideBar ?? data.Beam?.TorsionDist_Side);
            // Auto Arrangement
            setId('MaxLayers', data.Beam?.MaxLayers ?? 2);
            setId('MinBarsPerLayer', data.Beam?.MinBarsPerLayer ?? 2);
            setId('WebBarMinHeight', data.Beam?.WebBarMinHeight);
            setChk('PreferSingleDiameter', data.Beam?.PreferSingleDiameter ?? true);
            setChk('PreferSymmetric', data.Beam?.PreferSymmetric);
            setChk('PreferFewerBars', data.Beam?.PreferFewerBars ?? true);
            setChk('PreferEvenDiameter', data.Beam?.PreferEvenDiameter);
            // Stirrup Advanced
            setId('MinReinforcementRatio', data.Beam?.MinReinforcementRatio);
            setId('AutoLegsRules', data.Beam?.AutoLegsRules);
            setChk('AllowOddLegs', data.Beam?.AllowOddLegs);
            // Continuous Beam Rules
            setChk('ForceContinuousDiameter', data.Beam?.ForceContinuousDiameter ?? true);
            setChk('SingleDiameterPerSpan', data.Beam?.SingleDiameterPerSpan ?? true);
            setChk('AllowDiameterMixing', data.Beam?.AllowDiameterMixing ?? false);
            setId('MaxDiameterDiff', data.Beam?.MaxDiameterDiff ?? 1);
            setId('StandardBarLength', data.Beam?.StandardBarLength ?? 11700);
            setId('BeamLapSpliceMultiplier', data.Beam?.LapSpliceMultiplier ?? 40);
            setChk('MatchTopLayerBars', data.Beam?.MatchTopLayerBars ?? true);

            // Tab 2: Column
            setId('ColMainBarRange', data.Column?.MainBarRange);
            setId('ColStirrupBarRange', data.Column?.StirrupBarRange);
            setId('ColCover', data.Column?.Cover);
            setId('LapSpliceMultiplier', data.Column?.LapSpliceMultiplier);
            setId('MinBarsPerSide', data.Column?.MinBarsPerSide);
            setId('MaxStirrupSpacing', data.Column?.MaxStirrupSpacing);

            // Tab 3: Naming
            setId('BeamPrefix', data.Naming?.BeamPrefix);
            setId('GirderPrefix', data.Naming?.GirderPrefix);
            setId('ColumnPrefix', data.Naming?.ColumnPrefix);
            setId('BeamSuffix', data.Naming?.BeamSuffix);
            setChk('GroupByAxis', data.Naming?.GroupByAxis);
            setChk('MergeSameSection', data.Naming?.MergeSameSection);
            setChk('AutoRenameOnSectionChange', data.Naming?.AutoRenameOnSectionChange);

            // Sort Corner
            const corner = data.Naming?.SortCorner || 0;
            setId('SortCorner', corner);
            document.querySelectorAll('.corner-btn').forEach(btn => {
                btn.classList.toggle('active', parseInt(btn.dataset.corner) === corner);
                btn.onclick = () => {
                    document.querySelectorAll('.corner-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    document.getElementById('SortCorner').value = btn.dataset.corner;
                };
            });

            // Sort Direction
            const dir = data.Naming?.SortDirection || 0;
            setId('SortDirection', dir);
            document.querySelectorAll("input[name='sortDir']").forEach(radio => {
                radio.checked = parseInt(radio.value) === dir;
                radio.onchange = () => document.getElementById('SortDirection').value = radio.value;
            });

            // Tab 4: Anchorage
            if (document.getElementById('ConcreteGrade')) {
                document.getElementById('ConcreteGrade').value = data.Anchorage?.ConcreteGrade || 'B25';
                document.getElementById('SteelGrade').value = data.Anchorage?.SteelGrade || 'CB400V';
                setId('TensileSpliceFactor', data.Anchorage?.TensileSpliceFactor ?? 40);
                setId('CompressiveSpliceFactor', data.Anchorage?.CompressiveSpliceFactor ?? 30);
                setId('AnchorageFactor', data.Anchorage?.AnchorageFactor ?? 35);
                setId('Hook90Factor', data.Anchorage?.Hook90Factor ?? 12);
                setId('Hook135Factor', data.Anchorage?.Hook135Factor ?? 6);
                setId('Hook180Factor', data.Anchorage?.Hook180Factor ?? 4);
                setId('MinHookLength', data.Anchorage?.MinHookLength ?? 75);
            }

            // Tab 5: Detailing
            if (document.getElementById('MaxBarLength')) {
                setId('MaxBarLength', data.Detailing?.MaxBarLength ?? 11700);
                setId('MinBarLength', data.Detailing?.MinBarLength ?? 2000);
                setId('MinStaggerDistance', data.Detailing?.MinStaggerDistance ?? 600);
                setId('StaggerFactorLd', data.Detailing?.StaggerFactorLd ?? 1.3);
                setChk('SkipSplice', data.Detailing?.SkipSplice ?? false);

                // Beam Rule
                document.getElementById('BeamTopSpliceZone').value = data.Detailing?.BeamRule?.TopSpliceZone ?? 2;
                document.getElementById('BeamBotSpliceZone').value = data.Detailing?.BeamRule?.BotSpliceZone ?? 0;
                setChk('BeamAllowLapInJoint', data.Detailing?.BeamRule?.AllowLapSpliceInJoint ?? false);

                // Girder Rule
                document.getElementById('GirderTopSpliceZone').value = data.Detailing?.GirderRule?.TopSpliceZone ?? 1;
                document.getElementById('GirderBotSpliceZone').value = data.Detailing?.GirderRule?.BotSpliceZone ?? 0;
                setChk('GirderAllowLapInJoint', data.Detailing?.GirderRule?.AllowLapSpliceInJoint ?? true);
            }
        }

        function doSave() {
            const getVal = (id) => {
                const el = document.getElementById(id);
                if (!el) return '';
                if (el.type === 'number') {
                    const num = parseFloat(el.value);
                    return isNaN(num) ? 0 : num;
                }
                return el.value || '';
            };
            const getChk = (id) => { const el = document.getElementById(id); return el ? el.checked : false; };

            const result = {
                General: {
                    AvailableDiameters: getSelectedDiameters(),
                    ZoneL1_Ratio: getVal('ZoneL1_Ratio'),
                    ZoneL2_Ratio: getVal('ZoneL2_Ratio'),
                    Unit: document.getElementById('Unit').value,
                    DecimalPlaces: data.General?.DecimalPlaces || 2,
                    TextHeight: getVal('TextHeight') || 1
                },
                Beam: {
                    MainBarRange: getVal('MainBarRange') || '16-25',
                    StirrupBarRange: getVal('StirrupBarRange') || '8-10',
                    SideBarRange: getVal('SideBarRange') || '12-14',
                    CoverTop: getVal('CoverTop'),
                    CoverBot: getVal('CoverBot'),
                    CoverSide: getVal('CoverSide'),
                    // Clear Spacing
                    UseBarDiameterForSpacing: getChk('UseBarDiameterForSpacing'),
                    BarDiameterSpacingMultiplier: getVal('BarDiameterSpacingMultiplier') || 1.0,
                    MinClearSpacing: getVal('MinClearSpacing'),
                    MaxClearSpacing: getVal('MaxClearSpacing'),
                    // Torsion
                    TorsionDist_TopBar: getVal('TorsionDist_TopBar'),
                    TorsionDist_BotBar: getVal('TorsionDist_BotBar'),
                    TorsionDist_SideBar: getVal('TorsionDist_SideBar'),
                    // Auto Arrangement
                    MaxLayers: getVal('MaxLayers') || 2,
                    MinBarsPerLayer: getVal('MinBarsPerLayer') || 2,
                    WebBarMinHeight: getVal('WebBarMinHeight'),
                    PreferSingleDiameter: getChk('PreferSingleDiameter'),
                    PreferSymmetric: getChk('PreferSymmetric'),
                    PreferFewerBars: getChk('PreferFewerBars'),
                    PreferEvenDiameter: getChk('PreferEvenDiameter'),
                    // Stirrup
                    MinReinforcementRatio: getVal('MinReinforcementRatio'),
                    AutoLegsRules: getVal('AutoLegsRules') || '250-2 400-3 600-4',
                    AllowOddLegs: getChk('AllowOddLegs'),
                    // Continuous Beam Rules
                    ForceContinuousDiameter: getChk('ForceContinuousDiameter'),
                    SingleDiameterPerSpan: getChk('SingleDiameterPerSpan'),
                    AllowDiameterMixing: getChk('AllowDiameterMixing'),
                    MaxDiameterDiff: getVal('MaxDiameterDiff') || 1,
                    StandardBarLength: getVal('StandardBarLength') || 11700,
                    LapSpliceMultiplier: getVal('BeamLapSpliceMultiplier') || 40,
                    MatchTopLayerBars: getChk('MatchTopLayerBars')
                },
                Column: {
                    MainBarRange: getVal('ColMainBarRange') || '16-28',
                    StirrupBarRange: getVal('ColStirrupBarRange') || '8-10',
                    Cover: getVal('ColCover'),
                    LapSpliceMultiplier: getVal('LapSpliceMultiplier'),
                    MinBarsPerSide: getVal('MinBarsPerSide'),
                    MaxStirrupSpacing: getVal('MaxStirrupSpacing')
                },
                Naming: {
                    BeamPrefix: getVal('BeamPrefix') || 'B',
                    GirderPrefix: getVal('GirderPrefix') || 'G',
                    ColumnPrefix: getVal('ColumnPrefix') || 'C',
                    BeamSuffix: getVal('BeamSuffix'),
                    GroupByAxis: getChk('GroupByAxis'),
                    MergeSameSection: getChk('MergeSameSection'),
                    AutoRenameOnSectionChange: getChk('AutoRenameOnSectionChange'),
                    SortCorner: parseInt(getVal('SortCorner')) || 0,
                    SortDirection: parseInt(getVal('SortDirection')) || 0
                },
                Anchorage: {
                    ConcreteGrade: document.getElementById('ConcreteGrade')?.value || 'B25',
                    SteelGrade: document.getElementById('SteelGrade')?.value || 'CB400V',
                    UseSimplifiedRules: true,
                    TensileSpliceFactor: getVal('TensileSpliceFactor') || 40,
                    CompressiveSpliceFactor: getVal('CompressiveSpliceFactor') || 30,
                    AnchorageFactor: getVal('AnchorageFactor') || 35,
                    Hook90Factor: getVal('Hook90Factor') || 12,
                    Hook135Factor: getVal('Hook135Factor') || 6,
                    Hook180Factor: getVal('Hook180Factor') || 4,
                    MinHookLength: getVal('MinHookLength') || 75
                },
                Detailing: {
                    MaxBarLength: getVal('MaxBarLength') || 11700,
                    MinBarLength: getVal('MinBarLength') || 2000,
                    MinStaggerDistance: getVal('MinStaggerDistance') || 600,
                    StaggerFactorLd: getVal('StaggerFactorLd') || 1.3,
                    SkipSplice: getChk('SkipSplice'),
                    BeamRule: {
                        TopSpliceZone: parseInt(document.getElementById('BeamTopSpliceZone')?.value) || 2,
                        BotSpliceZone: parseInt(document.getElementById('BeamBotSpliceZone')?.value) || 0,
                        AllowLapSpliceInJoint: getChk('BeamAllowLapInJoint'),
                        SupportZoneRatio: 0.25
                    },
                    GirderRule: {
                        TopSpliceZone: parseInt(document.getElementById('GirderTopSpliceZone')?.value) || 1,
                        BotSpliceZone: parseInt(document.getElementById('GirderBotSpliceZone')?.value) || 0,
                        AllowLapSpliceInJoint: getChk('GirderAllowLapInJoint'),
                        SupportZoneRatio: 0.25
                    }
                }
            };

            window.chrome.webview.postMessage(JSON.stringify(result));
        }

        function doCancel() {
            window.chrome.webview.postMessage('CANCEL');
        }

        function doImport() {
            window.chrome.webview.postMessage('IMPORT');
        }

        function doExport() {
            window.chrome.webview.postMessage('EXPORT');
        }

        // Initialize form on load
        loadForm();
    </script>
</body>

</html>