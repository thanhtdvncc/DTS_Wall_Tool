<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background: #f5f5f5;
            margin: 0;
            padding: 0;
            color: #333;
            font-size: 13px;
            user-select: none;
        }

        .header {
            background: linear-gradient(135deg, #0d6efd, #0a58ca);
            color: #fff;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h2 {
            margin: 0;
            font-size: 15px;
        }

        .badge {
            background: rgba(255, 255, 255, .2);
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 11px;
        }

        .tabs {
            display: flex;
            background: #fff;
            border-bottom: 1px solid #dee2e6;
        }

        .tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            font-weight: 500;
            color: #6c757d;
            font-size: 12px;
        }

        .tab:hover {
            background: #f8f9fa;
        }

        .tab.active {
            color: #0d6efd;
            border-bottom-color: #0d6efd;
        }

        .content {
            padding: 15px;
            height: calc(100vh - 130px);
            /* Fill available space: 100vh - header(~50px) - tabs(~40px) - footer(~40px) */
            overflow-y: auto;
        }

        .tab-panel {
            display: none;
        }

        .tab-panel.active {
            display: block;
        }

        .section {
            background: #fff;
            border-radius: 6px;
            margin-bottom: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, .08);
        }

        .section-header {
            padding: 8px 12px;
            font-weight: 600;
            color: #495057;
            font-size: 12px;
            border-bottom: 1px solid #f0f0f0;
        }

        .section-body {
            padding: 12px;
        }

        .row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .row:last-child {
            margin-bottom: 0;
        }

        .col {
            flex: 1;
        }

        .col-2 {
            flex: 2;
        }

        label {
            display: block;
            font-size: 11px;
            color: #6c757d;
            margin-bottom: 4px;
        }

        input[type='text'],
        input[type='number'] {
            width: 100%;
            padding: 7px 10px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 12px;
        }

        input:focus {
            border-color: #86b7fe;
            outline: none;
            box-shadow: 0 0 0 2px rgba(13, 110, 253, .15);
        }

        .check-row {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px 0;
        }

        .check-row input[type='checkbox'] {
            width: 16px;
            height: 16px;
            accent-color: #0d6efd;
        }

        .check-row label {
            margin: 0;
            font-size: 12px;
            color: #333;
        }

        .hint {
            font-size: 10px;
            color: #adb5bd;
            margin-top: 3px;
        }

        .diameter-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .diameter-chip {
            padding: 6px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            background: #f8f9fa;
            transition: 0.2s;
        }

        .diameter-chip:hover {
            background: #e9ecef;
        }

        .diameter-chip.active {
            background: #0d6efd;
            color: #fff;
            border-color: #0d6efd;
        }

        .corner-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
            width: 120px;
        }

        .corner-btn {
            padding: 10px 8px;
            text-align: center;
            border: 1px solid #ced4da;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 500;
            background: #f8f9fa;
            transition: 0.2s;
        }

        .corner-btn:hover {
            background: #e9ecef;
        }

        .corner-btn.active {
            background: #0d6efd;
            color: #fff;
            border-color: #0d6efd;
        }

        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .radio-label {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            cursor: pointer;
        }

        .radio-label input {
            accent-color: #0d6efd;
        }

        .footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #fff;
            padding: 12px 20px;
            border-top: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .footer-left {
            display: flex;
            gap: 8px;
        }

        .footer-right {
            display: flex;
            gap: 10px;
        }

        button {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            font-weight: 600;
            font-size: 12px;
            cursor: pointer;
        }

        .btn-primary {
            background: #0d6efd;
            color: #fff;
        }

        .btn-primary:hover {
            background: #0b5ed7;
        }

        .btn-secondary {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
        }

        .btn-secondary:hover {
            background: #e9ecef;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 11px;
        }
    </style>
</head>

<body>
    <div class="header">
        <h2>DTS Rebar Configuration</h2>
        <span class="badge">v2.0</span>
    </div>

    <div class="tabs">
        <div class="tab active" onclick="showTab(0)">General</div>
        <div class="tab" onclick="showTab(1)">Beam</div>
        <div class="tab" onclick="showTab(2)">Column</div>
        <div class="tab" onclick="showTab(3)">Naming</div>
        <div class="tab" onclick="showTab(4)">Neo & N·ªëi</div>
        <div class="tab" onclick="showTab(5)">B·ªë tr√≠</div>
    </div>

    <div class="content">
        <!-- TAB 0: GENERAL -->
        <div class="tab-panel active" id="tab0">
            <div class="section">
                <div class="section-header">Kho th√©p chu·∫©n (Inventory)</div>
                <div class="section-body">
                    <div class="diameter-grid" id="inventoryGrid"></div>
                    <div class="hint">Click ƒë·ªÉ b·∫≠t/t·∫Øt ƒë∆∞·ªùng k√≠nh. C√°c ƒë∆∞·ªùng k√≠nh ƒë∆∞·ª£c ch·ªçn s·∫Ω kh·∫£ d·ª•ng cho t√≠nh to√°n.
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-header">ƒêo·∫°n x√©t n·ªôi l·ª±c (Analysis Zones)</div>
                <div class="section-body">
                    <div class="row">
                        <div class="col"><label>Zone L1 (ƒë·∫ßu nh·ªãp)</label><input type="number" id="ZoneL1_Ratio"
                                step="0.05" min="0" max="0.5"></div>
                        <div class="col"><label>Zone L2 (cu·ªëi nh·ªãp)</label><input type="number" id="ZoneL2_Ratio"
                                step="0.05" min="0" max="0.5"></div>
                        <div class="col"><label>ƒê∆°n v·ªã</label>
                            <select id="Unit"
                                style="width:100%;padding:7px;border:1px solid #ced4da;border-radius:4px;font-size:12px;">
                                <option value="mm">mm</option>
                                <option value="cm">cm</option>
                                <option value="m">m</option>
                            </select>
                        </div>
                    </div>
                    <div class="hint">Zone = t·ªâ l·ªá nh·ªãp ƒë·ªÉ l·∫•y Momen/L·ª±c c·∫Øt l·ªõn nh·∫•t. VD: 0.25 = 1/4 nh·ªãp.</div>
                </div>
            </div>

            <div class="section">
                <div class="section-header">C√†i ƒë·∫∑t Text Label</div>
                <div class="section-body">
                    <div class="row">
                        <div class="col"><label>Chi·ªÅu cao Text</label><input type="number" id="TextHeight" value="1"
                                step="0.1" min="0.1" max="10"></div>
                        <div class="col"></div>
                        <div class="col"></div>
                    </div>
                    <div class="hint">Chi·ªÅu cao text khi v·∫Ω label th√©p (m·∫∑c ƒë·ªãnh = 1). ƒêi·ªÅu ch·ªânh theo t·ª∑ l·ªá b·∫£n v·∫Ω.
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-header">M√°c v·∫≠t li·ªáu (Material Grades)
                    <button class="btn-sm" onclick="syncMaterialsFromAnchorage()"
                        style="font-size:10px;padding:1px 6px;margin-left:8px;"
                        title="L·∫•y danh s√°ch t·ª´ tab Neo & N·ªëi">üîÑ Sync</button>
                </div>
                <div class="section-body">
                    <div class="row">
                        <div class="col">
                            <label>M√°c th√©p ch·ªß</label>
                            <select id="SteelGradeName"
                                style="width:100%;padding:7px;border:1px solid #ced4da;border-radius:4px;font-size:12px;"
                                onchange="onSteelGradeChange()">
                                <option value="CB400-V">CB400-V (M·∫∑c ƒë·ªãnh)</option>
                            </select>
                        </div>
                        <div class="col">
                            <label>fy (MPa)</label>
                            <input type="number" id="SteelGradeMain" value="400" min="200" max="600"
                                style="background:#f5f5f5;">
                        </div>
                        <div class="col">
                            <label>Th√©p ƒëai fy (MPa)</label>
                            <input type="number" id="SteelGradeStirrup" value="300" min="200" max="500">
                        </div>
                    </div>
                    <div class="row" style="margin-top:8px;">
                        <div class="col">
                            <label>M√°c b√™ t√¥ng</label>
                            <select id="ConcreteGradeName"
                                style="width:100%;padding:7px;border:1px solid #ced4da;border-radius:4px;font-size:12px;"
                                onchange="onConcreteGradeChange()">
                                <option value="B25">B25 (M·∫∑c ƒë·ªãnh)</option>
                            </select>
                        </div>
                        <div class="col">
                            <label>f'c (MPa)</label>
                            <input type="number" id="ConcreteGrade" value="25" min="15" max="60"
                                style="background:#f5f5f5;">
                        </div>
                        <div class="col"></div>
                    </div>
                    <div class="hint">Click üîÑ Sync ƒë·ªÉ l·∫•y danh s√°ch v·∫≠t li·ªáu ƒë√£ ch·ªçn t·ª´ tab "Neo & N·ªëi". Ho·∫∑c nh·∫≠p tr·ª±c
                        ti·∫øp.
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-header">Import / Export Settings</div>
                <div class="section-body">
                    <div class="row">
                        <div class="col">
                            <button class="btn-secondary btn-sm" onclick="doImport()">Import</button>
                            <button class="btn-secondary btn-sm" onclick="doExport()">Export</button>
                        </div>
                    </div>
                    <div class="hint">L∆∞u/t·∫£i c·∫•u h√¨nh ƒë·ªÉ chia s·∫ª ho·∫∑c d√πng cho d·ª± √°n kh√°c (.dtss)</div>
                </div>
            </div>
        </div>

        <!-- TAB 1: BEAM -->
        <div class="tab-panel" id="tab1">
            <div class="section">
                <div class="section-header">Ph·∫°m vi th√©p (Rebar Selection)</div>
                <div class="section-body">
                    <div class="row">
                        <div class="col"><label>Th√©p ch·ªß (Main)</label><input type="text" id="MainBarRange"
                                placeholder="16-25"></div>
                        <div class="col"><label>Th√©p ƒëai (Stirrup)</label><input type="text" id="StirrupBarRange"
                                placeholder="8-10"></div>
                        <div class="col"><label>Th√©p h√¥ng (Side)</label><input type="text" id="SideBarRange"
                                placeholder="12-14"></div>
                    </div>
                    <div class="hint">Nh·∫≠p kho·∫£ng: "16-25" ho·∫∑c li·ªát k√™: "18, 20, 22". S·∫Ω l·ªçc theo Kho th√©p ·ªü tab
                        General.</div>
                </div>
            </div>

            <div class="section">
                <div class="section-header">L·ªõp b·∫£o v·ªá (mm)</div>
                <div class="section-body">
                    <div class="row">
                        <div class="col"><label>Cover Top</label><input type="number" id="CoverTop"></div>
                        <div class="col"><label>Cover Bot</label><input type="number" id="CoverBot"></div>
                        <div class="col"><label>Cover Side</label><input type="number" id="CoverSide"></div>
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-header">Kho·∫£ng h·ªü c·ªët th√©p (Clear Spacing)</div>
                <div class="section-body">
                    <div class="check-row">
                        <input type="checkbox" id="UseBarDiameterForSpacing">
                        <label for="UseBarDiameterForSpacing">Kho·∫£ng h·ªü t·ªëi thi·ªÉu theo ƒë∆∞·ªùng k√≠nh th√©p</label>
                    </div>
                    <div class="row">
                        <div class="col"><label>H·ªá s·ªë x ƒë∆∞·ªùng k√≠nh</label><input type="number"
                                id="BarDiameterSpacingMultiplier" step="0.1" min="1" max="3"></div>
                        <div class="col"><label>Min Spacing c·ªë ƒë·ªãnh (mm)</label><input type="number"
                                id="MinClearSpacing"></div>
                        <div class="col"><label>Max Spacing (mm)</label><input type="number" id="MaxClearSpacing"></div>
                    </div>
                    <div class="hint">N·∫øu b·∫≠t: spacing ‚â• N √ó d_max. N·∫øu t·∫Øt: d√πng Min Spacing c·ªë ƒë·ªãnh. Theo ACI/TCVN
                        th∆∞·ªùng ‚â• 1.0d.</div>
                </div>
            </div>

            <div class="section">
                <div class="section-header">H·ªá s·ªë ph√¢n b·ªï th√©p xo·∫Øn (Torsion Distribution)</div>
                <div class="section-body">
                    <div class="row">
                        <div class="col"><label>Top Bar</label><input type="number" id="TorsionDist_TopBar" step="0.01">
                        </div>
                        <div class="col"><label>Bot Bar</label><input type="number" id="TorsionDist_BotBar" step="0.01">
                        </div>
                        <div class="col"><label>Side Bar</label><input type="number" id="TorsionDist_SideBar"
                                step="0.01"></div>
                    </div>
                    <div class="hint">T·ªïng = 1.0. VD: TopBar=0.16, BotBar=0.16, SideBar=0.68</div>
                </div>
            </div>

            <div class="section">
                <div class="section-header">B·ªë tr√≠ th√©p t·ª± ƒë·ªông (Auto Arrangement)</div>
                <div class="section-body">
                    <div class="row">
                        <div class="col"><label>S·ªë l·ªõp t·ªëi ƒëa</label><input type="number" id="MaxLayers" min="1"
                                max="5"></div>
                        <div class="col"><label>Min thanh/l·ªõp</label><input type="number" id="MinBarsPerLayer" min="2"
                                max="10"></div>
                        <div class="col"><label>H min th√©p s∆∞·ªùn (mm)</label><input type="number" id="WebBarMinHeight">
                        </div>
                    </div>
                    <div class="check-row"><input type="checkbox" id="PreferSingleDiameter"><label
                            for="PreferSingleDiameter">∆Øu ti√™n c√πng 1 ƒë∆∞·ªùng k√≠nh (c√°c l·ªõp)</label></div>
                    <div class="check-row"><input type="checkbox" id="PreferSymmetric"><label for="PreferSymmetric">∆Øu
                            ti√™n b·ªë tr√≠ ƒë·ªëi x·ª©ng</label></div>
                    <div class="check-row"><input type="checkbox" id="PreferFewerBars"><label for="PreferFewerBars">∆Øu
                            ti√™n √≠t thanh h∆°n (ƒë∆∞·ªùng k√≠nh l·ªõn)</label></div>
                    <div class="check-row"><input type="checkbox" id="PreferEvenDiameter"><label
                            for="PreferEvenDiameter">∆Øu ti√™n ƒë∆∞·ªùng k√≠nh ch·∫µn</label></div>
                </div>
            </div>

            <div class="section">
                <div class="section-header">Th√©p ƒëai n√¢ng cao</div>
                <div class="section-body">
                    <div class="row">
                        <div class="col"><label>Œº_min</label><input type="number" id="MinReinforcementRatio"
                                step="0.001"></div>
                        <div class="col-2"><label>Auto Legs Rules</label><input type="text" id="AutoLegsRules"
                                placeholder="250-2 400-3 600-4"></div>
                    </div>
                    <div class="check-row"><input type="checkbox" id="AllowOddLegs"><label for="AllowOddLegs">Cho ph√©p
                            nh√°nh ƒëai l·∫ª (3, 5...)</label></div>
                    <div class="hint">Auto Legs: b‚â§250‚Üí2 nh√°nh, b‚â§400‚Üí3 nh√°nh...</div>
                </div>
            </div>

            <div class="section">
                <div class="section-header">Quy t·∫Øc d·∫ßm li√™n t·ª•c (Continuous Beam)</div>
                <div class="section-body">
                    <div class="check-row"><input type="checkbox" id="ForceContinuousDiameter" checked><label
                            for="ForceContinuousDiameter">ƒê·ªìng b·ªô ƒë∆∞·ªùng k√≠nh ch·∫°y su·ªët (Layer 1)</label></div>
                    <div class="check-row"><input type="checkbox" id="SingleDiameterPerSpan" checked><label
                            for="SingleDiameterPerSpan">M·ªôt lo·∫°i ƒë∆∞·ªùng k√≠nh/m·∫∑t c·∫Øt</label></div>
                    <div class="check-row"><input type="checkbox" id="AllowDiameterMixing"><label
                            for="AllowDiameterMixing">Cho ph√©p ph·ªëi ƒë∆∞·ªùng k√≠nh</label></div>
                    <div class="row">
                        <div class="col"><label>Max Diff (c·∫•p)</label><input type="number" id="MaxDiameterDiff"
                                value="1" min="1" max="3"></div>
                        <div class="col"><label>Th√©p ti√™u chu·∫©n (mm)</label><input type="number" id="StandardBarLength"
                                value="11700"></div>
                        <div class="col"><label>N·ªëi ch·ªìng (xd)</label><input type="number" id="BeamLapSpliceMultiplier"
                                value="40"></div>
                    </div>
                    <div class="check-row"><input type="checkbox" id="MatchTopLayerBars" checked><label
                            for="MatchTopLayerBars">Kh·ªõp s·ªë thanh l·ªõp tr√™n (Match Top Layer)</label></div>
                    <div class="hint">Quy t·∫Øc √°p d·ª•ng khi t√≠nh th√©p d·∫£i d·∫ßm li√™n t·ª•c (Girder/Beam ch·∫°y qua nhi·ªÅu c·ªôt).
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB 2: COLUMN -->
        <div class="tab-panel" id="tab2">
            <div class="section">
                <div class="section-header">Ph·∫°m vi th√©p c·ªôt</div>
                <div class="section-body">
                    <div class="row">
                        <div class="col"><label>Th√©p ch·ªß (Main)</label><input type="text" id="ColMainBarRange"
                                placeholder="16-28"></div>
                        <div class="col"><label>Th√©p ƒëai (Stirrup)</label><input type="text" id="ColStirrupBarRange"
                                placeholder="8-10"></div>
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-header">L·ªõp b·∫£o v·ªá & Quy t·∫Øc</div>
                <div class="section-body">
                    <div class="row">
                        <div class="col"><label>Cover (mm)</label><input type="number" id="ColCover"></div>
                        <div class="col"><label>N·ªëi ch·ªìng (xd)</label><input type="number" id="LapSpliceMultiplier">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col"><label>Min thanh/c·∫°nh</label><input type="number" id="MinBarsPerSide"></div>
                        <div class="col"><label>Max Stirrup Spacing</label><input type="number" id="MaxStirrupSpacing">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB 3: NAMING -->
        <div class="tab-panel" id="tab3">
            <!-- STORY CONFIGURATION (PRIMARY) -->
            <div class="section" style="background:#e8f4fd;border:1px solid #3b82f6;">
                <div class="section-header" style="background:#3b82f6;color:white;">üìç C·∫•u h√¨nh T·∫ßng (Story
                    Configuration)</div>
                <div class="section-body">
                    <!-- Controls row - all aligned inline -->
                    <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;">
                        <div style="display:flex;align-items:center;gap:6px;">
                            <label style="margin:0;white-space:nowrap;">Dung sai (mm)</label>
                            <input type="number" id="StoryTolerance" value="500" min="100" max="5000"
                                style="width:70px;">
                        </div>
                        <button class="btn-primary" id="btnGetStories" onclick="getStoriesFromSAP()">
                            <span id="btnGetStoriesText">üì• Get Stories</span>
                        </button>
                        <button class="btn-secondary btn-sm" onclick="addStoryRow()">‚ûï Th√™m t·∫ßng</button>
                        <div style="display:flex;align-items:center;gap:4px;margin-left:auto;">
                            <input type="checkbox" id="AutoFillStory" checked style="margin:0;">
                            <label for="AutoFillStory" style="margin:0;font-size:11px;white-space:nowrap;">üîÑ Auto
                                Fill</label>
                        </div>
                    </div>

                    <!-- Story Config Table -->
                    <div style="margin-top:10px;max-height:220px;overflow-y:auto;">
                        <table id="storyConfigTable" style="width:100%;border-collapse:collapse;font-size:11px;">
                            <thead style="background:#f0f0f0;position:sticky;top:0;">
                                <tr>
                                    <th style="padding:5px;border:1px solid #ddd;width:10%;">Start Index</th>
                                    <th
                                        style="padding:5px;border:1px solid #ddd;width:15%;background:#f5f5f5;color:#666;">
                                        Story Name</th>
                                    <th
                                        style="padding:5px;border:1px solid #ddd;width:12%;background:#f5f5f5;color:#666;">
                                        Level (mm)</th>
                                    <th style="padding:5px;border:1px solid #ddd;width:12%;">Beam</th>
                                    <th style="padding:5px;border:1px solid #ddd;width:12%;">Girder</th>
                                    <th style="padding:5px;border:1px solid #ddd;width:12%;">Column</th>
                                    <th style="padding:5px;border:1px solid #ddd;width:17%;">Suffix</th>
                                    <th style="padding:5px;border:1px solid #ddd;width:10%;">X√≥a</th>
                                </tr>
                            </thead>
                            <tbody id="storyConfigBody">
                                <!-- Rows populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-header">Quy t·∫Øc nh√≥m</div>
                <div class="section-body">
                    <div class="check-row"><input type="checkbox" id="GroupByAxis"><label for="GroupByAxis">Nh√≥m theo
                            tr·ª•c</label></div>
                    <div class="check-row"><input type="checkbox" id="MergeSameSection"><label
                            for="MergeSameSection">G·ªôp d·∫ßm c√πng section & rebar (s·ª≠ d·ª•ng Signature)</label></div>
                    <div class="check-row"><input type="checkbox" id="AutoRenameOnSectionChange"><label
                            for="AutoRenameOnSectionChange">T·ª± rename khi section ƒë·ªïi</label></div>
                </div>
            </div>

            <div class="section">
                <div class="section-header">Th·ª© t·ª± qu√©t (Sorting)</div>
                <div class="section-body">
                    <div class="row">
                        <div class="col">
                            <label style="margin-bottom: 8px;">G√≥c b·∫Øt ƒë·∫ßu</label>
                            <div class="corner-grid">
                                <div class="corner-btn" data-corner="0">‚îè TL</div>
                                <div class="corner-btn" data-corner="1">TR ‚îì</div>
                                <div class="corner-btn" data-corner="2">‚îó BL</div>
                                <div class="corner-btn" data-corner="3">BR ‚îõ</div>
                            </div>
                            <input type="hidden" id="SortCorner" value="0">
                        </div>
                        <div class="col">
                            <label style="margin-bottom: 8px;">H∆∞·ªõng ∆∞u ti√™n</label>
                            <div class="radio-group">
                                <label class="radio-label"><input type="radio" name="sortDir" value="0" checked> Ngang
                                    (X)</label>
                                <label class="radio-label"><input type="radio" name="sortDir" value="1"> D·ªçc (Y)</label>
                            </div>
                            <input type="hidden" id="SortDirection" value="0">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB 4: ANCHORAGE (Neo & N·ªëi) - COMPREHENSIVE -->
        <div class="tab-panel" id="tab4">
            <!-- QUICK PRESETS TOOLBAR -->
            <div class="section" style="background:#e8f4fd;border:1px solid #3b82f6;">
                <div class="section-header" style="background:#3b82f6;color:white;">‚ö° Quick Presets</div>
                <div class="section-body">
                    <div style="display:flex;gap:16px;">
                        <!-- LEFT: Preset Buttons -->
                        <div style="flex:1;">
                            <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px;">
                                <button id="presetTCVN" class="btn-primary" onclick="loadPreset('TCVN')"
                                    title="TCVN 5574:2018">
                                    <img src="https://flagcdn.com/w20/vn.png"
                                        style="width:16px;height:12px;margin-right:2px;"> TCVN</button>
                                <button id="presetACI" class="btn-secondary" onclick="loadPreset('ACI')"
                                    title="ACI 318-19">
                                    <img src="https://flagcdn.com/w20/us.png"
                                        style="width:16px;height:12px;margin-right:2px;"> ACI</button>
                                <button id="presetEUROCODE" class="btn-secondary" onclick="loadPreset('EUROCODE')"
                                    title="Eurocode 2">
                                    <img src="https://flagcdn.com/w20/eu.png"
                                        style="width:16px;height:12px;margin-right:2px;"> EC2</button>
                                <button id="presetRC" class="btn-secondary" onclick="loadPreset('RC')"
                                    title="Standard RC SD420">üìã RC</button>
                            </div>
                            <!-- Saved Presets -->
                            <div id="savedPresetsContainer" style="display:flex;gap:4px;flex-wrap:wrap;"></div>
                            <div class="hint" style="margin-top:6px;">
                                Ti√™u chu·∫©n: <b id="currentStandard">TCVN</b> | Ch·∫ø ƒë·ªô: <b id="currentModeLabel">H·ªá s·ªë
                                    √ód</b>
                            </div>
                        </div>
                        <!-- RIGHT: Action Buttons -->
                        <div style="display:flex;flex-direction:column;gap:4px;min-width:80px;">
                            <button class="btn-secondary btn-sm" onclick="saveCurrentPreset()" title="L∆∞u">üíæ
                                L∆∞u</button>
                            <button class="btn-secondary btn-sm" onclick="createNewPreset()" title="T·∫°o m·ªõi">‚ûï
                                T·∫°o</button>
                            <button class="btn-secondary btn-sm" onclick="deleteSavedPreset()" title="X√≥a">üóëÔ∏è
                                X√≥a</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- MODE TOGGLE -->
            <div class="section">
                <div class="section-header">1. Ch·∫ø ƒë·ªô t√≠nh to√°n</div>
                <div class="section-body">
                    <div style="display:flex;align-items:center;gap:16px;">
                        <label style="display:flex;align-items:center;gap:6px;cursor:pointer;">
                            <input type="radio" name="calcMode" value="ByFactor" checked
                                onchange="switchMode('ByFactor')">
                            <b>üî¢ H·ªá s·ªë √ód</b>
                        </label>
                        <label style="display:flex;align-items:center;gap:6px;cursor:pointer;">
                            <input type="radio" name="calcMode" value="ByLength" onchange="switchMode('ByLength')">
                            <b>üìè Chi·ªÅu d√†i mm</b>
                        </label>
                        <span style="color:#666;font-size:11px;">(Chuy·ªÉn ƒë·ªïi s·∫Ω t·ª± ƒë·ªông quy ƒë·ªïi gi√° tr·ªã)</span>
                    </div>
                </div>
            </div>

            <!-- SHUTTLE SELECTOR -->
            <div class="section">
                <div class="section-header">2. Ch·ªçn V·∫≠t li·ªáu D·ª± √°n</div>
                <div class="section-body">
                    <div style="display:flex;gap:16px;">
                        <!-- CONCRETE SELECTOR -->
                        <div style="flex:1;">
                            <label style="font-weight:600;margin-bottom:4px;display:block;">
                                M√°c B√™ t√¥ng
                                <button class="btn-sm" onclick="editMaterialList('concrete')" title="Th√™m/X√≥a m√°c"
                                    style="font-size:10px;padding:1px 4px;">‚úèÔ∏è</button>
                            </label>
                            <div style="display:flex;gap:4px;">
                                <select id="availableConcrete" multiple size="5" style="flex:1;min-width:70px;"
                                    ondblclick="editMaterialList('concrete')"></select>
                                <div style="display:flex;flex-direction:column;gap:2px;justify-content:center;">
                                    <button class="btn-sm" onclick="shuttleConcrete('add')" title="Th√™m">‚ñ∂</button>
                                    <button class="btn-sm" onclick="shuttleConcrete('remove')" title="B·ªè">‚óÄ</button>
                                </div>
                                <select id="selectedConcrete" multiple size="5"
                                    style="flex:1;min-width:70px;font-weight:600;background:#e8f5e9;"></select>
                            </div>
                        </div>

                        <!-- STEEL SELECTOR -->
                        <div style="flex:1;">
                            <label style="font-weight:600;margin-bottom:4px;display:block;">
                                M√°c Th√©p
                                <button class="btn-sm" onclick="editMaterialList('steel')" title="Th√™m/X√≥a m√°c"
                                    style="font-size:10px;padding:1px 4px;">‚úèÔ∏è</button>
                            </label>
                            <div style="display:flex;gap:4px;">
                                <select id="availableSteel" multiple size="5" style="flex:1;min-width:70px;"
                                    ondblclick="editMaterialList('steel')"></select>
                                <div style="display:flex;flex-direction:column;gap:2px;justify-content:center;">
                                    <button class="btn-sm" onclick="shuttleSteel('add')" title="Th√™m">‚ñ∂</button>
                                    <button class="btn-sm" onclick="shuttleSteel('remove')" title="B·ªè">‚óÄ</button>
                                </div>
                                <select id="selectedSteel" multiple size="5"
                                    style="flex:1;min-width:70px;font-weight:600;background:#e8f5e9;"></select>
                            </div>
                        </div>
                    </div>
                    <div class="hint">Click ƒë√∫p v√†o danh s√°ch ƒë·ªÉ th√™m/x√≥a m√°c v·∫≠t li·ªáu. Ctrl+Click ƒë·ªÉ ch·ªçn nhi·ªÅu.</div>
                </div>
            </div>

            <!-- ANCHORAGE MATRIX -->
            <div class="section">
                <div class="section-header">3. B·∫£ng tra Neo (Development Length)</div>
                <div class="section-body" style="overflow-x:auto;">
                    <div id="anchorageMatrixWrapper"></div>
                    <div class="hint" id="anchorageHint">H√†ng = ƒê∆∞·ªùng k√≠nh, C·ªôt = C·∫∑p v·∫≠t li·ªáu. Nh·∫≠p h·ªá s·ªë √ód.</div>
                </div>
            </div>

            <!-- SPLICE MATRIX -->
            <div class="section">
                <div class="section-header">4. B·∫£ng tra N·ªëi (Lap Splice Length)</div>
                <div class="section-body" style="overflow-x:auto;">
                    <div id="spliceMatrixWrapper"></div>
                    <div class="hint">Th∆∞·ªùng = Neo √ó 1.3. Nh·∫≠p tr·ª±c ti·∫øp n·∫øu kh√°c ti√™u chu·∫©n.</div>
                </div>
            </div>

            <!-- HOOK CONFIG -->
            <div class="section">
                <div class="section-header">5. Quy c√°ch M√≥c (Standard Hooks)</div>
                <div class="section-body">
                    <div class="row">
                        <div class="col"><label>M√≥c 90¬∞ (√ód)</label><input type="number" id="Hook90Factor" value="12">
                        </div>
                        <div class="col"><label>Min 90¬∞ (mm)</label><input type="number" id="MinHook90Length"
                                value="150"></div>
                        <div class="col"><label>M√≥c 135¬∞ (√ód)</label><input type="number" id="Hook135Factor" value="6">
                        </div>
                        <div class="col"><label>M√≥c 180¬∞ (√ód)</label><input type="number" id="Hook180Factor" value="4">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col"><label>Chi·ªÅu d√†i m√≥c min (mm)</label><input type="number" id="MinHookLength"
                                value="75"></div>
                        <div class="col"><label>Neo m·∫∑c ƒë·ªãnh (√ód)</label><input type="number"
                                id="DefaultAnchorageFactor" value="40"></div>
                        <div class="col"><label>N·ªëi m·∫∑c ƒë·ªãnh (√ód)</label><input type="number" id="DefaultSpliceFactor"
                                value="52"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB 5: DETAILING (B·ªë tr√≠) -->
        <div class="tab-panel" id="tab5">
            <div class="section">
                <div class="section-header">Gi·ªõi h·∫°n thanh th√©p</div>
                <div class="section-body">
                    <div class="row">
                        <div class="col"><label>Chi·ªÅu d√†i max (mm)</label><input type="number" id="MaxBarLength"
                                value="11700"></div>
                        <div class="col"><label>Chi·ªÅu d√†i min (mm)</label><input type="number" id="MinBarLength"
                                value="2000"></div>
                    </div>
                    <div class="row">
                        <div class="col"><label>Kho·∫£ng so le n·ªëi (mm)</label><input type="number"
                                id="MinStaggerDistance" value="600"></div>
                        <div class="col"><label>H·ªá s·ªë so le (√óLd)</label><input type="number" id="StaggerFactorLd"
                                value="1.3" step="0.1"></div>
                    </div>
                    <div class="check-row">
                        <input type="checkbox" id="SkipSplice">
                        <label for="SkipSplice"><strong>B·ªè qua n·ªëi th√©p</strong> (nh√† cung c·∫•p c·∫Øt theo y√™u c·∫ßu)</label>
                    </div>
                    <div class="hint">Khi b·∫≠t: th√©p ƒë∆∞·ª£c v·∫Ω li·ªÅn m·∫°ch, kh√¥ng hi·ªÉn th·ªã ƒëi·ªÉm n·ªëi.</div>
                </div>
            </div>

            <div class="section">
                <div class="section-header">V√πng n·ªëi th√©p - D·∫ßm ph·ª• (Beam)</div>
                <div class="section-body">
                    <div class="row">
                        <div class="col">
                            <label>Th√©p tr√™n n·ªëi t·∫°i</label>
                            <select id="BeamTopSpliceZone">
                                <option value="0">T·∫°i g·ªëi (Support)</option>
                                <option value="1">L/4</option>
                                <option value="2" selected>Gi·ªØa nh·ªãp (Mid)</option>
                            </select>
                        </div>
                        <div class="col">
                            <label>Th√©p d∆∞·ªõi n·ªëi t·∫°i</label>
                            <select id="BeamBotSpliceZone">
                                <option value="0" selected>T·∫°i g·ªëi (Support)</option>
                                <option value="1">L/4</option>
                                <option value="2">Gi·ªØa nh·ªãp (Mid)</option>
                            </select>
                        </div>
                    </div>
                    <div class="check-row">
                        <input type="checkbox" id="BeamAllowLapInJoint">
                        <label for="BeamAllowLapInJoint">Cho ph√©p n·ªëi trong n√∫t khung</label>
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-header">V√πng n·ªëi th√©p - D·∫ßm ch√≠nh (Girder)</div>
                <div class="section-body">
                    <div class="row">
                        <div class="col">
                            <label>Th√©p tr√™n n·ªëi t·∫°i</label>
                            <select id="GirderTopSpliceZone">
                                <option value="0">T·∫°i g·ªëi (Support)</option>
                                <option value="1" selected>L/4</option>
                                <option value="2">Gi·ªØa nh·ªãp (Mid)</option>
                            </select>
                        </div>
                        <div class="col">
                            <label>Th√©p d∆∞·ªõi n·ªëi t·∫°i</label>
                            <select id="GirderBotSpliceZone">
                                <option value="0" selected>T·∫°i g·ªëi (Support)</option>
                                <option value="1">L/4</option>
                                <option value="2">Gi·ªØa nh·ªãp (Mid)</option>
                            </select>
                        </div>
                    </div>
                    <div class="check-row">
                        <input type="checkbox" id="GirderAllowLapInJoint" checked>
                        <label for="GirderAllowLapInJoint">Cho ph√©p n·ªëi trong n√∫t khung (Neo xuy√™n c·ªôt)</label>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="footer">
        <div class="footer-left">
            <!-- Import/Export moved to General tab -->
        </div>
        <div class="footer-right">
            <button class="btn-secondary" onclick="doCancel()">H·ªßy b·ªè</button>
            <button class="btn-primary" onclick="doSave()">L∆∞u c·∫•u h√¨nh</button>
        </div>
    </div>

    <script>
        const data = __SETTINGS_JSON__;
        const ALL_DIAMETERS = [6, 8, 10, 12, 13, 14, 16, 18, 19, 20, 22, 25, 28, 29, 32, 36, 40];

        function showTab(idx) {
            document.querySelectorAll('.tab').forEach((t, i) => t.classList.toggle('active', i === idx));
            document.querySelectorAll('.tab-panel').forEach((p, i) => p.classList.toggle('active', i === idx));
        }

        function buildInventoryGrid() {
            const grid = document.getElementById('inventoryGrid');
            const available = data.General?.AvailableDiameters || [];
            grid.innerHTML = '';
            ALL_DIAMETERS.forEach(d => {
                const chip = document.createElement('div');
                chip.className = 'diameter-chip' + (available.includes(d) ? ' active' : '');
                chip.textContent = '√ò' + d;
                chip.dataset.diameter = d;
                chip.onclick = () => {
                    chip.classList.toggle('active');
                    // Sync with Tab 4 anchorage matrix (re-render to update row visibility)
                    if (typeof renderDiameterMatrices === 'function') {
                        renderDiameterMatrices();
                    }
                };
                grid.appendChild(chip);
            });
        }

        function getSelectedDiameters() {
            const chips = document.querySelectorAll('#inventoryGrid .diameter-chip.active');
            return Array.from(chips).map(c => parseInt(c.dataset.diameter)).sort((a, b) => a - b);
        }

        // ============ ANCHORAGE COMPREHENSIVE FUNCTIONS ============
        const DIAMETERS = [10, 12, 13, 14, 16, 18, 19, 20, 22, 25, 28, 29, 32, 36];

        let anchorageState = {
            mode: 'ByFactor', // or 'ByLength'
            standardName: 'TCVN',
            availableConcrete: ['B15', 'B20', 'B25', 'B30', 'B35', 'B40'],
            availableSteel: ['CB240', 'CB300', 'CB400', 'CB500'],
            selectedConcrete: ['B20', 'B25', 'B30'],
            selectedSteel: ['CB300', 'CB400'],
            anchorageValues: {}, // key: "B25_CB400", subkey: diameter, value: factor/length
            spliceValues: {}
        };

        // ===== PRESETS =====
        const PRESETS = {
            TCVN: {
                name: 'TCVN 5574:2018',
                mode: 'ByFactor',
                availableConcrete: ['B15', 'B20', 'B25', 'B30', 'B35', 'B40'],
                availableSteel: ['CB240', 'CB300', 'CB400', 'CB500'],
                selectedConcrete: ['B20', 'B25', 'B30'],
                selectedSteel: ['CB300', 'CB400'],
                generateData: () => {
                    const anc = {}, spl = {};
                    ['B20', 'B25', 'B30'].forEach(c => {
                        ['CB300', 'CB400'].forEach(s => {
                            const key = `${c}_${s}`;
                            let base = c === 'B20' ? 45 : c === 'B25' ? 40 : 35;
                            if (s === 'CB400') base += 5;
                            anc[key] = {}; spl[key] = {};
                            DIAMETERS.forEach(d => { anc[key][d] = base; spl[key][d] = Math.round(base * 1.3); });
                        });
                    });
                    return { anchorageValues: anc, spliceValues: spl };
                }
            },
            RC: {
                name: 'Standard RC (SD420)',
                mode: 'ByLength',
                availableConcrete: ['210', '280', '350'],
                availableSteel: ['SD420'],
                selectedConcrete: ['210', '280', '350'],
                selectedSteel: ['SD420'],
                generateData: () => {
                    const anc = {}, spl = {};
                    // 210
                    anc['210_SD420'] = { 10: 420, 13: 560, 16: 700, 19: 840, 22: 1100, 25: 1420, 29: 1870, 32: 2370, 36: 2890 };
                    spl['210_SD420'] = { 10: 550, 13: 730, 16: 910, 19: 1100, 22: 1430, 25: 1850, 29: 2440, 32: 3090, 36: 3760 };
                    // 280
                    anc['280_SD420'] = { 10: 360, 13: 490, 16: 600, 19: 730, 22: 950, 25: 1230, 29: 1620, 32: 2050, 36: 2500 };
                    spl['280_SD420'] = { 10: 470, 13: 640, 16: 790, 19: 950, 22: 1240, 25: 1600, 29: 2110, 32: 2670, 36: 3250 };
                    // 350
                    anc['350_SD420'] = { 10: 340, 13: 450, 16: 550, 19: 670, 22: 870, 25: 1130, 29: 1490, 32: 1890, 36: 2310 };
                    spl['350_SD420'] = { 10: 440, 13: 590, 16: 720, 19: 870, 22: 1140, 25: 1470, 29: 1940, 32: 2460, 36: 3010 };
                    return { anchorageValues: anc, spliceValues: spl };
                }
            },
            ACI: {
                name: 'ACI 318-19',
                mode: 'ByFactor',
                availableConcrete: ['3000', '4000', '5000', '6000'],
                availableSteel: ['Grade40', 'Grade60'],
                selectedConcrete: ['4000', '5000'],
                selectedSteel: ['Grade60'],
                generateData: () => {
                    const anc = {}, spl = {};
                    ['4000', '5000'].forEach(c => {
                        ['Grade60'].forEach(s => {
                            const key = `${c}_${s}`;
                            let base = c === '4000' ? 48 : 42;
                            anc[key] = {}; spl[key] = {};
                            DIAMETERS.forEach(d => { anc[key][d] = base; spl[key][d] = Math.round(base * 1.3); });
                        });
                    });
                    return { anchorageValues: anc, spliceValues: spl };
                }
            },
            EUROCODE: {
                name: 'Eurocode 2',
                mode: 'ByFactor',
                availableConcrete: ['C20/25', 'C25/30', 'C30/37', 'C35/45'],
                availableSteel: ['B500A', 'B500B', 'B500C'],
                selectedConcrete: ['C25/30', 'C30/37'],
                selectedSteel: ['B500B'],
                generateData: () => {
                    const anc = {}, spl = {};
                    ['C25/30', 'C30/37'].forEach(c => {
                        ['B500B'].forEach(s => {
                            const key = `${c}_${s}`;
                            let base = c === 'C25/30' ? 44 : 38;
                            anc[key] = {}; spl[key] = {};
                            DIAMETERS.forEach(d => { anc[key][d] = base; spl[key][d] = Math.round(base * 1.5); });
                        });
                    });
                    return { anchorageValues: anc, spliceValues: spl };
                }
            }
        };

        function loadPreset(presetName) {
            const preset = PRESETS[presetName];
            if (!preset) return;

            anchorageState.standardName = preset.name;
            anchorageState.mode = preset.mode;
            anchorageState.availableConcrete = [...preset.availableConcrete];
            anchorageState.availableSteel = [...preset.availableSteel];
            anchorageState.selectedConcrete = [...preset.selectedConcrete];
            anchorageState.selectedSteel = [...preset.selectedSteel];

            const data = preset.generateData();
            anchorageState.anchorageValues = data.anchorageValues;
            anchorageState.spliceValues = data.spliceValues;

            // Update UI
            document.getElementById('currentStandard').textContent = preset.name;
            document.querySelector(`input[name="calcMode"][value="${preset.mode}"]`).checked = true;
            highlightPresetButton(presetName);
            updateModeLabel();
            updateAnchorageHint();
            renderShuttleSelectors();
            renderDiameterMatrices();
        }

        function highlightPresetButton(activePreset) {
            ['TCVN', 'ACI', 'EUROCODE', 'RC'].forEach(p => {
                const btn = document.getElementById('preset' + p);
                if (btn) {
                    if (p === activePreset) {
                        btn.classList.remove('btn-secondary');
                        btn.classList.add('btn-primary');
                    } else {
                        btn.classList.remove('btn-primary');
                        btn.classList.add('btn-secondary');
                    }
                }
            });
        }

        // ===== MODE SWITCH WITH AUTO-CONVERT =====
        function switchMode(newMode) {
            const oldMode = anchorageState.mode;
            if (oldMode === newMode) return;

            // Auto-convert values without confirm
            [anchorageState.anchorageValues, anchorageState.spliceValues].forEach(valueMap => {
                for (const key in valueMap) {
                    for (const d in valueMap[key]) {
                        const diameter = parseInt(d);
                        let val = valueMap[key][d];
                        if (newMode === 'ByLength' && oldMode === 'ByFactor') {
                            valueMap[key][d] = Math.round(val * diameter);
                        } else if (newMode === 'ByFactor' && oldMode === 'ByLength') {
                            valueMap[key][d] = Math.round(val / diameter);
                        }
                    }
                }
            });

            anchorageState.mode = newMode;
            updateModeLabel();
            updateAnchorageHint();
            renderDiameterMatrices();
        }

        function updateModeLabel() {
            const label = document.getElementById('currentModeLabel');
            if (label) {
                label.textContent = anchorageState.mode === 'ByLength' ? 'Chi·ªÅu d√†i mm' : 'H·ªá s·ªë √ód';
            }
        }

        function updateAnchorageHint() {
            const hint = document.getElementById('anchorageHint');
            if (anchorageState.mode === 'ByLength') {
                hint.textContent = 'Nh·∫≠p chi·ªÅu d√†i tuy·ªát ƒë·ªëi (mm). VD: 800 = 800mm';
            } else {
                hint.textContent = 'Nh·∫≠p h·ªá s·ªë √ód. VD: 40 = 40√ód = 40√ó20mm = 800mm';
            }
        }

        // ===== SHUTTLE SELECTOR =====
        function renderShuttleSelectors() {
            // Concrete
            const availC = document.getElementById('availableConcrete');
            const selC = document.getElementById('selectedConcrete');
            availC.innerHTML = anchorageState.availableConcrete
                .filter(g => !anchorageState.selectedConcrete.includes(g))
                .map(g => `<option value="${g}">${g}</option>`).join('');
            selC.innerHTML = sortGrades(anchorageState.selectedConcrete)
                .map(g => `<option value="${g}">${g}</option>`).join('');

            // Steel
            const availS = document.getElementById('availableSteel');
            const selS = document.getElementById('selectedSteel');
            availS.innerHTML = anchorageState.availableSteel
                .filter(g => !anchorageState.selectedSteel.includes(g))
                .map(g => `<option value="${g}">${g}</option>`).join('');
            selS.innerHTML = sortGrades(anchorageState.selectedSteel)
                .map(g => `<option value="${g}">${g}</option>`).join('');
        }

        function sortGrades(grades) {
            return grades.slice().sort((a, b) => {
                const numA = parseFloat(a.replace(/[^0-9.]/g, '')) || 0;
                const numB = parseFloat(b.replace(/[^0-9.]/g, '')) || 0;
                return numA - numB;
            });
        }

        function shuttleConcrete(action) {
            const avail = document.getElementById('availableConcrete');
            const sel = document.getElementById('selectedConcrete');
            if (action === 'add') {
                Array.from(avail.selectedOptions).forEach(opt => {
                    anchorageState.selectedConcrete.push(opt.value);
                });
            } else {
                const toRemove = Array.from(sel.selectedOptions).map(o => o.value);
                anchorageState.selectedConcrete = anchorageState.selectedConcrete.filter(g => !toRemove.includes(g));
            }
            renderShuttleSelectors();
            renderDiameterMatrices();
        }

        function shuttleSteel(action) {
            const avail = document.getElementById('availableSteel');
            const sel = document.getElementById('selectedSteel');
            if (action === 'add') {
                Array.from(avail.selectedOptions).forEach(opt => {
                    anchorageState.selectedSteel.push(opt.value);
                });
            } else {
                const toRemove = Array.from(sel.selectedOptions).map(o => o.value);
                anchorageState.selectedSteel = anchorageState.selectedSteel.filter(g => !toRemove.includes(g));
            }
            renderShuttleSelectors();
            renderDiameterMatrices();
        }

        // ===== EDIT MATERIAL LIST POPUP =====
        function editMaterialList(type) {
            const isConc = type === 'concrete';
            const list = isConc ? anchorageState.availableConcrete : anchorageState.availableSteel;
            const label = isConc ? 'M√°c B√™ t√¥ng' : 'M√°c Th√©p';

            const current = list.join(', ');
            const input = prompt(
                `Ch·ªânh s·ª≠a danh s√°ch ${label}:\n\n` +
                `Nh·∫≠p c√°c m√°c c√°ch nhau b·ªüi d·∫•u ph·∫©y (,)\n` +
                `VD: B20, B25, B30\n\n` +
                `Danh s√°ch hi·ªán t·∫°i:`,
                current
            );

            if (input !== null) {
                const newList = input.split(',').map(s => s.trim().toUpperCase()).filter(s => s);
                if (isConc) {
                    anchorageState.availableConcrete = newList;
                    // Keep only selected items that still exist in available
                    anchorageState.selectedConcrete = anchorageState.selectedConcrete.filter(g => newList.includes(g));
                } else {
                    anchorageState.availableSteel = newList;
                    anchorageState.selectedSteel = anchorageState.selectedSteel.filter(g => newList.includes(g));
                }
                renderShuttleSelectors();
                renderDiameterMatrices();
            }
        }

        // ===== SAVE/LOAD PRESET =====
        function saveCurrentPreset() {
            const name = prompt('Nh·∫≠p t√™n preset:', anchorageState.standardName || 'My Preset');
            if (!name) return;

            const presetData = {
                name: name,
                mode: anchorageState.mode,
                availableConcrete: anchorageState.availableConcrete,
                availableSteel: anchorageState.availableSteel,
                selectedConcrete: anchorageState.selectedConcrete,
                selectedSteel: anchorageState.selectedSteel,
                anchorageValues: anchorageState.anchorageValues,
                spliceValues: anchorageState.spliceValues
            };

            localStorage.setItem('DTS_AnchoragePreset_' + name.replace(/\s/g, '_'), JSON.stringify(presetData));
            anchorageState.standardName = name;
            document.getElementById('currentStandard').textContent = name;
            renderSavedPresets(); // Update UI
        }

        function renderSavedPresets() {
            const container = document.getElementById('savedPresetsContainer');
            if (!container) return;

            const presets = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('DTS_AnchoragePreset_')) {
                    presets.push(key.replace('DTS_AnchoragePreset_', '').replace(/_/g, ' '));
                }
            }

            if (presets.length === 0) {
                container.innerHTML = '<span style="color:#999;font-size:11px;">Ch∆∞a c√≥ preset ƒë√£ l∆∞u</span>';
                return;
            }

            container.innerHTML = presets.map(p =>
                `<button class="btn-secondary btn-sm" onclick="loadSavedPresetByName('${p.replace(/'/g, "\\'")}')" 
                    style="font-size:10px;padding:2px 6px;" title="${p}">üìÅ ${p}</button>`
            ).join('');
        }

        function loadSavedPresetByName(name) {
            const key = 'DTS_AnchoragePreset_' + name.replace(/\s/g, '_');
            const dataStr = localStorage.getItem(key);
            if (!dataStr) return;

            try {
                const presetData = JSON.parse(dataStr);
                Object.assign(anchorageState, presetData);
                document.getElementById('currentStandard').textContent = presetData.name;
                document.querySelector(`input[name="calcMode"][value="${presetData.mode}"]`).checked = true;
                updateModeLabel();
                updateAnchorageHint();
                renderShuttleSelectors();
                renderDiameterMatrices();
            } catch (e) {
                alert('L·ªói ƒë·ªçc preset: ' + e.message);
            }
        }

        function createNewPreset() {
            const name = prompt('Nh·∫≠p t√™n preset m·ªõi:');
            if (!name) return;

            // Reset to empty state
            anchorageState.standardName = name;
            anchorageState.mode = 'ByFactor';
            anchorageState.availableConcrete = ['B20', 'B25', 'B30', 'B35'];
            anchorageState.availableSteel = ['CB300', 'CB400'];
            anchorageState.selectedConcrete = ['B25'];
            anchorageState.selectedSteel = ['CB400'];
            anchorageState.anchorageValues = {};
            anchorageState.spliceValues = {};

            // Auto-save to localStorage
            const presetData = {
                name: name,
                mode: anchorageState.mode,
                availableConcrete: anchorageState.availableConcrete,
                availableSteel: anchorageState.availableSteel,
                selectedConcrete: anchorageState.selectedConcrete,
                selectedSteel: anchorageState.selectedSteel,
                anchorageValues: anchorageState.anchorageValues,
                spliceValues: anchorageState.spliceValues
            };
            localStorage.setItem('DTS_AnchoragePreset_' + name.replace(/\s/g, '_'), JSON.stringify(presetData));

            // Update UI
            document.getElementById('currentStandard').textContent = name;
            document.querySelector('input[name="calcMode"][value="ByFactor"]').checked = true;
            highlightPresetButton(null); // No preset active
            updateModeLabel();
            updateAnchorageHint();
            renderShuttleSelectors();
            renderDiameterMatrices();
            renderSavedPresets(); // Update saved presets list
        }

        function deleteSavedPreset() {
            const presets = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('DTS_AnchoragePreset_')) {
                    presets.push(key.replace('DTS_AnchoragePreset_', '').replace(/_/g, ' '));
                }
            }

            if (presets.length === 0) {
                alert('Ch∆∞a c√≥ preset n√†o ƒë∆∞·ª£c l∆∞u.');
                return;
            }

            const name = prompt('Ch·ªçn preset ƒë·ªÉ X√ìA:\n\n' + presets.map((p, i) => `${i + 1}. ${p}`).join('\n') + '\n\nNh·∫≠p s·ªë th·ª© t·ª±:');
            const idx = parseInt(name) - 1;
            if (isNaN(idx) || idx < 0 || idx >= presets.length) return;

            const key = 'DTS_AnchoragePreset_' + presets[idx].replace(/\s/g, '_');
            if (confirm(`X√≥a preset "${presets[idx]}"?`)) {
                localStorage.removeItem(key);
                renderSavedPresets(); // Update UI after delete
                alert('ƒê√£ x√≥a.');
            }
        }

        // ===== GET ACTIVE DIAMETERS FROM GENERAL TAB =====
        function getActiveDiameters() {
            const chips = document.querySelectorAll('#inventoryGrid .diameter-chip.active');
            return Array.from(chips).map(c => parseInt(c.dataset.diameter)).sort((a, b) => a - b);
        }

        // ===== DIAMETER-BASED MATRIX WITH SYNC =====
        function renderDiameterMatrices() {
            renderDiameterMatrix('anchorageMatrixWrapper', anchorageState.anchorageValues, 'anc');
            renderDiameterMatrix('spliceMatrixWrapper', anchorageState.spliceValues, 'spl');
        }

        function renderDiameterMatrix(wrapperId, valueMap, prefix) {
            const wrapper = document.getElementById(wrapperId);
            if (!wrapper) return;

            const concretes = sortGrades(anchorageState.selectedConcrete);
            const steels = sortGrades(anchorageState.selectedSteel);
            const activeDiams = getActiveDiameters(); // Sync with General tab

            if (concretes.length === 0 || steels.length === 0) {
                wrapper.innerHTML = '<p style="color:#999;">Ch·ªçn v·∫≠t li·ªáu b√™n tr√™n ƒë·ªÉ hi·ªÉn th·ªã b·∫£ng.</p>';
                return;
            }

            // Build material pairs as columns
            const pairs = [];
            concretes.forEach(c => steels.forEach(s => pairs.push({ c, s, key: `${c}_${s}` })));

            let html = `<table id="${prefix}Table" class="matrix-table" style="width:100%;font-size:11px;border-collapse:collapse;">
                <thead><tr>
                    <th style="border:1px solid #ccc;background:#e3f2fd;padding:4px;min-width:40px;">√ò</th>`;
            pairs.forEach((p, colIdx) => {
                html += `<th style="border:1px solid #ccc;background:#f0f0f0;padding:4px;text-align:center;min-width:55px;cursor:pointer;" onclick="selectMatrixCol('${prefix}', ${colIdx}, ${DIAMETERS.length})">${p.c}<br>${p.s}</th>`;
            });
            html += '</tr></thead><tbody>';

            DIAMETERS.forEach((d, rowIdx) => {
                const isActive = activeDiams.length === 0 || activeDiams.includes(d);
                const rowStyle = isActive ? '' : 'opacity:0.4;background:#f9f9f9;';
                html += `<tr style="${rowStyle}"><td style="border:1px solid #ccc;background:#f5f5f5;padding:4px;font-weight:600;cursor:pointer;" onclick="selectMatrixRow('${prefix}', ${rowIdx}, ${pairs.length})">D${d}</td>`;
                pairs.forEach(p => {
                    const val = valueMap[p.key]?.[d] ?? '';
                    html += `<td style="border:1px solid #ccc;padding:0;"><input type="text" 
                        data-prefix="${prefix}" data-key="${p.key}" data-diameter="${d}"
                        value="${val}" style="width:100%;text-align:center;border:none;background:transparent;padding:3px;box-sizing:border-box;"
                        onchange="updateMatrixValue(this)" onfocus="this.select()"></td>`;
                });
                html += '</tr>';
            });
            html += '</tbody></table>';
            wrapper.innerHTML = html;

            // Add event listeners for Excel-like behavior
            const allInputs = wrapper.querySelectorAll('input');
            allInputs.forEach((input, idx) => {
                input.addEventListener('paste', handleExcelPaste);
                input.addEventListener('keydown', (e) => handleMatrixKeydown(e, allInputs, idx, pairs.length));
            });
        }

        // ===== EXCEL KEYBOARD NAVIGATION =====
        function handleMatrixKeydown(e, allInputs, currentIdx, colCount) {
            const key = e.key;
            const ctrl = e.ctrlKey;

            // Ctrl+A = select ALL cells in the table
            if (ctrl && key === 'a') {
                e.preventDefault();
                allInputs.forEach(inp => {
                    inp.classList.add('selected');
                    inp.style.background = '#bbdefb';
                });
                return;
            }

            // Arrow key navigation
            let newIdx = currentIdx;
            if (key === 'ArrowRight' || key === 'Tab') {
                if (!e.shiftKey) {
                    newIdx = currentIdx + 1;
                    if (key === 'Tab') e.preventDefault();
                }
            } else if (key === 'ArrowLeft' || (key === 'Tab' && e.shiftKey)) {
                newIdx = currentIdx - 1;
                if (key === 'Tab') e.preventDefault();
            } else if (key === 'ArrowDown' || key === 'Enter') {
                newIdx = currentIdx + colCount;
                e.preventDefault();
            } else if (key === 'ArrowUp') {
                newIdx = currentIdx - colCount;
                e.preventDefault();
            }

            // Ctrl + Arrow = jump to edge
            if (ctrl) {
                if (key === 'ArrowRight') newIdx = Math.floor(currentIdx / colCount) * colCount + colCount - 1;
                else if (key === 'ArrowLeft') newIdx = Math.floor(currentIdx / colCount) * colCount;
                else if (key === 'ArrowDown') newIdx = (allInputs.length - colCount) + (currentIdx % colCount);
                else if (key === 'ArrowUp') newIdx = currentIdx % colCount;
            }

            // Focus new cell if valid
            if (newIdx >= 0 && newIdx < allInputs.length && newIdx !== currentIdx) {
                allInputs[newIdx].focus();
                allInputs[newIdx].select();
            }
        }

        // ===== MATRIX SELECTION HELPERS =====
        function selectMatrixRow(prefix, rowIdx, colCount) {
            clearMatrixSelection();
            const table = document.getElementById(prefix + 'Table');
            if (!table) return;
            const inputs = table.querySelectorAll('tbody tr')[rowIdx]?.querySelectorAll('input');
            inputs?.forEach(inp => {
                inp.classList.add('selected');
                inp.style.background = '#bbdefb';
            });
        }

        function selectMatrixCol(prefix, colIdx, rowCount) {
            clearMatrixSelection();
            const table = document.getElementById(prefix + 'Table');
            if (!table) return;
            const rows = table.querySelectorAll('tbody tr');
            rows.forEach(row => {
                const inputs = row.querySelectorAll('input');
                if (inputs[colIdx]) {
                    inputs[colIdx].classList.add('selected');
                    inputs[colIdx].style.background = '#bbdefb';
                }
            });
        }

        function clearMatrixSelection() {
            document.querySelectorAll('.matrix-table input.selected').forEach(inp => {
                inp.classList.remove('selected');
                inp.style.background = 'transparent';
            });
        }

        // ===== EXCEL PASTE SUPPORT =====
        function handleExcelPaste(e) {
            const clipData = e.clipboardData.getData('text');
            if (!clipData.includes('\t') && !clipData.includes('\n')) return; // Not tabular data

            e.preventDefault();
            const rows = clipData.trim().split('\n').map(r => r.split('\t'));
            const startInput = e.target;
            const table = startInput.closest('table');
            const allInputs = Array.from(table.querySelectorAll('input'));
            const startIdx = allInputs.indexOf(startInput);
            const colCount = table.querySelectorAll('thead th').length - 1; // Minus diameter column

            let idx = startIdx;
            rows.forEach(row => {
                row.forEach(val => {
                    if (allInputs[idx]) {
                        const numVal = parseFloat(val) || 0;
                        allInputs[idx].value = numVal;
                        updateMatrixValue(allInputs[idx]);
                    }
                    idx++;
                });
                // Move to next row
                idx = startIdx + (Math.floor((idx - startIdx) / colCount) + 1) * colCount;
            });
        }

        function updateMatrixValue(input) {
            const prefix = input.dataset.prefix;
            const key = input.dataset.key;
            const diameter = parseInt(input.dataset.diameter);
            const value = parseFloat(input.value) || 0;

            const map = prefix === 'anc' ? anchorageState.anchorageValues : anchorageState.spliceValues;
            if (!map[key]) map[key] = {};
            map[key][diameter] = value;
        }

        // ===== LOAD/SAVE =====
        function loadAnchorageTab() {
            // Load from data or use defaults
            if (data.Anchorage?.StandardName) {
                anchorageState.standardName = data.Anchorage.StandardName;
            }
            if (data.Anchorage?.Mode) {
                anchorageState.mode = data.Anchorage.Mode;
            }
            if (data.Anchorage?.AvailableConcreteGrades) {
                anchorageState.availableConcrete = data.Anchorage.AvailableConcreteGrades;
            }
            if (data.Anchorage?.AvailableSteelGrades) {
                anchorageState.availableSteel = data.Anchorage.AvailableSteelGrades;
            }
            if (data.Anchorage?.ConcreteGrades) {
                anchorageState.selectedConcrete = data.Anchorage.ConcreteGrades;
            }
            if (data.Anchorage?.SteelGrades) {
                anchorageState.selectedSteel = data.Anchorage.SteelGrades;
            }
            if (data.Anchorage?.AnchorageValues) {
                anchorageState.anchorageValues = data.Anchorage.AnchorageValues;
            }
            if (data.Anchorage?.SpliceValues) {
                anchorageState.spliceValues = data.Anchorage.SpliceValues;
            }

            // Update UI
            document.getElementById('currentStandard').textContent = anchorageState.standardName;
            const modeRadio = document.querySelector(`input[name="calcMode"][value="${anchorageState.mode}"]`);
            if (modeRadio) modeRadio.checked = true;
            updateAnchorageHint();
            renderShuttleSelectors();
            renderDiameterMatrices();
        }

        function collectAnchorageData() {
            const getVal = (id) => { const el = document.getElementById(id); return el ? parseFloat(el.value) || 0 : 0; };

            return {
                StandardName: anchorageState.standardName,
                Mode: anchorageState.mode,
                AvailableConcreteGrades: [...anchorageState.availableConcrete],
                AvailableSteelGrades: [...anchorageState.availableSteel],
                ConcreteGrades: [...anchorageState.selectedConcrete],
                SteelGrades: [...anchorageState.selectedSteel],
                AnchorageValues: JSON.parse(JSON.stringify(anchorageState.anchorageValues)),
                SpliceValues: JSON.parse(JSON.stringify(anchorageState.spliceValues)),
                Hook90Factor: getVal('Hook90Factor') || 12,
                MinHook90Length: getVal('MinHook90Length') || 150,
                Hook135Factor: getVal('Hook135Factor') || 6,
                Hook180Factor: getVal('Hook180Factor') || 4,
                MinHookLength: getVal('MinHookLength') || 75,
                DefaultAnchorageFactor: getVal('DefaultAnchorageFactor') || 40,
                DefaultSpliceFactor: getVal('DefaultSpliceFactor') || 52
            };
        }

        // === MATERIAL SYNC FROM ANCHORAGE TAB ===
        // Grade lookup tables (common Vietnamese/International standards)
        const steelGradeLookup = {
            'CB240-T': 240, 'CB300-V': 300, 'CB300-T': 300,
            'CB400-V': 400, 'CB400-T': 400, 'CB500-V': 500, 'CB500-T': 500,
            'SD295': 295, 'SD345': 345, 'SD420': 420, 'SD500': 500,
            'Fy500': 500, 'Fy420': 420, 'Fy300': 300
        };
        const concreteGradeLookup = {
            'B15': 11, 'B20': 14, 'B22.5': 16, 'B25': 18, 'B30': 22,
            'B35': 25, 'B40': 29, 'B45': 32, 'B50': 36, 'B55': 40, 'B60': 43,
            'C20': 20, 'C25': 25, 'C30': 30, 'C35': 35, 'C40': 40, 'C50': 50
        };

        function syncMaterialsFromAnchorage() {
            // Get selected items from Anchorage tab (shuttle lists)
            const selectedSteelSel = document.getElementById('selectedSteel');
            const selectedConcreteSel = document.getElementById('selectedConcrete');

            if (!selectedSteelSel || !selectedConcreteSel) {
                alert('Ch∆∞a c√≥ d·ªØ li·ªáu. Vui l√≤ng v√†o tab "Neo & N·ªëi" v√† ch·ªçn v·∫≠t li·ªáu tr∆∞·ªõc.');
                return;
            }

            // Update Steel dropdown
            const steelDropdown = document.getElementById('SteelGradeName');
            const steelOptions = Array.from(selectedSteelSel.options);
            if (steelOptions.length > 0) {
                const currentVal = steelDropdown.value;
                steelDropdown.innerHTML = '';
                steelOptions.forEach(opt => {
                    const newOpt = document.createElement('option');
                    newOpt.value = opt.value;
                    newOpt.textContent = opt.textContent;
                    steelDropdown.appendChild(newOpt);
                });
                // Try to keep current selection, else select first
                if (steelOptions.some(o => o.value === currentVal)) {
                    steelDropdown.value = currentVal;
                } else {
                    steelDropdown.selectedIndex = 0;
                }
                onSteelGradeChange();
            }

            // Update Concrete dropdown
            const concreteDropdown = document.getElementById('ConcreteGradeName');
            const concreteOptions = Array.from(selectedConcreteSel.options);
            if (concreteOptions.length > 0) {
                const currentVal = concreteDropdown.value;
                concreteDropdown.innerHTML = '';
                concreteOptions.forEach(opt => {
                    const newOpt = document.createElement('option');
                    newOpt.value = opt.value;
                    newOpt.textContent = opt.textContent;
                    concreteDropdown.appendChild(newOpt);
                });
                if (concreteOptions.some(o => o.value === currentVal)) {
                    concreteDropdown.value = currentVal;
                } else {
                    concreteDropdown.selectedIndex = 0;
                }
                onConcreteGradeChange();
            }

            alert('‚úÖ ƒê√£ ƒë·ªìng b·ªô v·∫≠t li·ªáu t·ª´ tab Neo & N·ªëi!');
        }

        function onSteelGradeChange() {
            const sel = document.getElementById('SteelGradeName');
            const fyInput = document.getElementById('SteelGradeMain');
            if (!sel || !fyInput) return;

            const gradeName = sel.value;
            // Lookup fy, fallback to current value
            if (steelGradeLookup[gradeName]) {
                fyInput.value = steelGradeLookup[gradeName];
            }
        }

        function onConcreteGradeChange() {
            const sel = document.getElementById('ConcreteGradeName');
            const fcInput = document.getElementById('ConcreteGrade');
            if (!sel || !fcInput) return;

            const gradeName = sel.value;
            // Lookup f'c, fallback to current value
            if (concreteGradeLookup[gradeName]) {
                fcInput.value = concreteGradeLookup[gradeName];
            }
        }

        function loadForm() {
            const setId = (id, val) => { const el = document.getElementById(id); if (el) el.value = val ?? ''; };
            const setChk = (id, val) => { const el = document.getElementById(id); if (el) el.checked = val || false; };

            // Build inventory grid
            buildInventoryGrid();

            // Tab 0: General
            setId('ZoneL1_Ratio', data.General?.ZoneL1_Ratio);
            setId('ZoneL2_Ratio', data.General?.ZoneL2_Ratio);
            if (data.General?.Unit) document.getElementById('Unit').value = data.General.Unit;
            setId('TextHeight', data.General?.TextHeight ?? 1);
            // Material Grades
            setId('SteelGradeName', data.General?.SteelGradeName ?? 'CB400-V');
            setId('SteelGradeMain', data.General?.SteelGradeMain ?? 400);
            setId('SteelGradeStirrup', data.General?.SteelGradeStirrup ?? 300);
            setId('ConcreteGradeName', data.General?.ConcreteGradeName ?? 'B25');
            setId('ConcreteGrade', data.General?.ConcreteGrade ?? 25);

            // Tab 1: Beam
            setId('MainBarRange', data.Beam?.MainBarRange);
            setId('StirrupBarRange', data.Beam?.StirrupBarRange);
            setId('SideBarRange', data.Beam?.SideBarRange);
            setId('CoverTop', data.Beam?.CoverTop);
            setId('CoverBot', data.Beam?.CoverBot);
            setId('CoverSide', data.Beam?.CoverSide);
            // Clear Spacing
            setChk('UseBarDiameterForSpacing', data.Beam?.UseBarDiameterForSpacing ?? true);
            setId('BarDiameterSpacingMultiplier', data.Beam?.BarDiameterSpacingMultiplier ?? 1.0);
            setId('MinClearSpacing', data.Beam?.MinClearSpacing);
            setId('MaxClearSpacing', data.Beam?.MaxClearSpacing);
            // Torsion (new names)
            setId('TorsionDist_TopBar', data.Beam?.TorsionDist_TopBar ?? data.Beam?.TorsionDist_Top);
            setId('TorsionDist_BotBar', data.Beam?.TorsionDist_BotBar ?? data.Beam?.TorsionDist_Bot);
            setId('TorsionDist_SideBar', data.Beam?.TorsionDist_SideBar ?? data.Beam?.TorsionDist_Side);
            // Auto Arrangement
            setId('MaxLayers', data.Beam?.MaxLayers ?? 2);
            setId('MinBarsPerLayer', data.Beam?.MinBarsPerLayer ?? 2);
            setId('WebBarMinHeight', data.Beam?.WebBarMinHeight);
            setChk('PreferSingleDiameter', data.Beam?.PreferSingleDiameter ?? true);
            setChk('PreferSymmetric', data.Beam?.PreferSymmetric);
            setChk('PreferFewerBars', data.Beam?.PreferFewerBars ?? true);
            setChk('PreferEvenDiameter', data.Beam?.PreferEvenDiameter);
            // Stirrup Advanced
            setId('MinReinforcementRatio', data.Beam?.MinReinforcementRatio);
            setId('AutoLegsRules', data.Beam?.AutoLegsRules);
            setChk('AllowOddLegs', data.Beam?.AllowOddLegs);
            // Continuous Beam Rules
            setChk('ForceContinuousDiameter', data.Beam?.ForceContinuousDiameter ?? true);
            setChk('SingleDiameterPerSpan', data.Beam?.SingleDiameterPerSpan ?? true);
            setChk('AllowDiameterMixing', data.Beam?.AllowDiameterMixing ?? false);
            setId('MaxDiameterDiff', data.Beam?.MaxDiameterDiff ?? 1);
            setId('StandardBarLength', data.Beam?.StandardBarLength ?? 11700);
            setId('BeamLapSpliceMultiplier', data.Beam?.LapSpliceMultiplier ?? 40);
            setChk('MatchTopLayerBars', data.Beam?.MatchTopLayerBars ?? true);

            // Tab 2: Column
            setId('ColMainBarRange', data.Column?.MainBarRange);
            setId('ColStirrupBarRange', data.Column?.StirrupBarRange);
            setId('ColCover', data.Column?.Cover);
            setId('LapSpliceMultiplier', data.Column?.LapSpliceMultiplier);
            setId('MinBarsPerSide', data.Column?.MinBarsPerSide);
            setId('MaxStirrupSpacing', data.Column?.MaxStirrupSpacing);

            // Tab 3: Naming
            setId('BeamPrefix', data.Naming?.BeamPrefix);
            setId('GirderPrefix', data.Naming?.GirderPrefix);
            setId('ColumnPrefix', data.Naming?.ColumnPrefix);
            setId('BeamSuffix', data.Naming?.BeamSuffix);
            setChk('GroupByAxis', data.Naming?.GroupByAxis);
            setChk('MergeSameSection', data.Naming?.MergeSameSection);
            setChk('AutoRenameOnSectionChange', data.Naming?.AutoRenameOnSectionChange);

            // Sort Corner
            const corner = data.Naming?.SortCorner || 0;
            setId('SortCorner', corner);
            document.querySelectorAll('.corner-btn').forEach(btn => {
                btn.classList.toggle('active', parseInt(btn.dataset.corner) === corner);
                btn.onclick = () => {
                    document.querySelectorAll('.corner-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    document.getElementById('SortCorner').value = btn.dataset.corner;
                };
            });

            // Sort Direction
            const dir = data.Naming?.SortDirection || 0;
            setId('SortDirection', dir);
            document.querySelectorAll("input[name='sortDir']").forEach(radio => {
                radio.checked = parseInt(radio.value) === dir;
                radio.onchange = () => document.getElementById('SortDirection').value = radio.value;
            });

            // Tab 4: Anchorage - Matrix based
            loadAnchorageTab();

            // Hook settings
            setId('Hook90Factor', data.Anchorage?.Hook90Factor ?? 12);
            setId('MinHook90Length', data.Anchorage?.MinHook90Length ?? 150);
            setId('Hook135Factor', data.Anchorage?.Hook135Factor ?? 6);
            setId('Hook180Factor', data.Anchorage?.Hook180Factor ?? 4);
            setId('MinHookLength', data.Anchorage?.MinHookLength ?? 75);
            setId('DefaultAnchorageFactor', data.Anchorage?.DefaultAnchorageFactor ?? 40);
            setId('DefaultSpliceFactor', data.Anchorage?.DefaultSpliceFactor ?? 52);

            // Tab 5: Detailing
            if (document.getElementById('MaxBarLength')) {
                setId('MaxBarLength', data.Detailing?.MaxBarLength ?? 11700);
                setId('MinBarLength', data.Detailing?.MinBarLength ?? 2000);
                setId('MinStaggerDistance', data.Detailing?.MinStaggerDistance ?? 600);
                setId('StaggerFactorLd', data.Detailing?.StaggerFactorLd ?? 1.3);
                setChk('SkipSplice', data.Detailing?.SkipSplice ?? false);

                // Beam Rule
                document.getElementById('BeamTopSpliceZone').value = data.Detailing?.BeamRule?.TopSpliceZone ?? 2;
                document.getElementById('BeamBotSpliceZone').value = data.Detailing?.BeamRule?.BotSpliceZone ?? 0;
                setChk('BeamAllowLapInJoint', data.Detailing?.BeamRule?.AllowLapSpliceInJoint ?? false);

                // Girder Rule
                document.getElementById('GirderTopSpliceZone').value = data.Detailing?.GirderRule?.TopSpliceZone ?? 1;
                document.getElementById('GirderBotSpliceZone').value = data.Detailing?.GirderRule?.BotSpliceZone ?? 0;
                setChk('GirderAllowLapInJoint', data.Detailing?.GirderRule?.AllowLapSpliceInJoint ?? true);
            }

            // Tab 4: Anchorage - Initialize saved presets and matrix
            renderSavedPresets();
            renderShuttleSelectors();
            renderDiameterMatrices();

            // Tab 3: Naming - Load Story Configs (NEW)
            console.log('[loadForm] data.StoryConfigs:', data.StoryConfigs);
            console.log('[loadForm] StoryConfigs length:', data.StoryConfigs?.length || 0);
            loadStoryTable(data.StoryConfigs || []);
            setId('StoryTolerance', data.StoryTolerance ?? 500);
        }

        // ===== STORY CONFIGURATION FUNCTIONS (NEW) =====
        function loadStoryTable(configs) {
            const tbody = document.getElementById('storyConfigBody');
            if (!tbody) return;
            tbody.innerHTML = '';
            if (!configs || configs.length === 0) return;
            configs.forEach((cfg, idx) => addStoryRowData(cfg));
        }

        function addStoryRow() {
            const tbody = document.getElementById('storyConfigBody');
            const rowCount = tbody.querySelectorAll('tr').length;
            // Get previous row's prefixes to cascade
            let prevBeam = 'B', prevGirder = 'G', prevColumn = 'C', prevSuffix = '';
            if (rowCount > 0) {
                const lastRow = tbody.querySelector('tr:last-child');
                prevBeam = lastRow.querySelector('.storyBeamPrefix')?.value || 'B';
                prevGirder = lastRow.querySelector('.storyGirderPrefix')?.value || 'G';
                prevColumn = lastRow.querySelector('.storyColumnPrefix')?.value || 'C';
                prevSuffix = lastRow.querySelector('.storySuffix')?.value || '';
            }
            addStoryRowData({
                StoryName: `L${rowCount + 1}`,
                Elevation: (rowCount + 1) * 3500,
                StartIndex: rowCount + 1,
                BeamPrefix: prevBeam,
                GirderPrefix: prevGirder,
                ColumnPrefix: prevColumn,
                Suffix: prevSuffix
            });
        }

        function addStoryRowData(cfg) {
            const tbody = document.getElementById('storyConfigBody');
            if (!tbody) return;
            const rowIdx = tbody.querySelectorAll('tr').length;
            const tr = document.createElement('tr');
            tr.dataset.rowIndex = rowIdx;

            // Start Index | Story Name (readonly) | Level (readonly) | Beam | Girder | Column | Suffix | Delete
            tr.innerHTML = `
                <td style="padding:4px;border:1px solid #ddd;">
                    <input type="number" class="storyStartIdx" value="${cfg.StartIndex || 1}" 
                           style="width:100%;padding:3px;border:1px solid #ccc;border-radius:3px;text-align:center;"
                           onchange="onSmartFillChange(this, 'startIndex')">
                </td>
                <td style="padding:4px;border:1px solid #ddd;background:#fafafa;">
                    <span class="storyName" style="font-weight:500;color:#555;">${cfg.StoryName || ''}</span>
                </td>
                <td style="padding:4px;border:1px solid #ddd;background:#fafafa;text-align:right;">
                    <span class="storyElev" style="color:#777;">${cfg.Elevation || 0}</span>
                    <input type="hidden" class="storyElevHidden" value="${cfg.Elevation || 0}">
                </td>
                <td style="padding:4px;border:1px solid #ddd;">
                    <input type="text" class="storyBeamPrefix" value="${cfg.BeamPrefix || 'B'}" 
                           style="width:100%;padding:3px;border:1px solid #ccc;border-radius:3px;text-align:center;"
                           onchange="onSmartFillChange(this, 'beam')">
                </td>
                <td style="padding:4px;border:1px solid #ddd;">
                    <input type="text" class="storyGirderPrefix" value="${cfg.GirderPrefix || 'G'}" 
                           style="width:100%;padding:3px;border:1px solid #ccc;border-radius:3px;text-align:center;"
                           onchange="onSmartFillChange(this, 'girder')">
                </td>
                <td style="padding:4px;border:1px solid #ddd;">
                    <input type="text" class="storyColumnPrefix" value="${cfg.ColumnPrefix || 'C'}" 
                           style="width:100%;padding:3px;border:1px solid #ccc;border-radius:3px;text-align:center;"
                           onchange="onSmartFillChange(this, 'column')">
                </td>
                <td style="padding:4px;border:1px solid #ddd;">
                    <input type="text" class="storySuffix" value="${cfg.Suffix || ''}" 
                           style="width:100%;padding:3px;border:1px solid #ccc;border-radius:3px;"
                           onchange="onSmartFillChange(this, 'suffix')">
                </td>
                <td style="padding:4px;border:1px solid #ddd;text-align:center;">
                    <button onclick="deleteStoryRow(this)" style="background:#dc3545;color:white;border:none;border-radius:3px;padding:2px 6px;cursor:pointer;">‚úï</button>
                </td>
            `;
            tbody.appendChild(tr);
        }

        // === SMART FILL CASCADE LOGIC ===
        function onSmartFillChange(input, fieldType) {
            // Check if AutoFill is enabled
            const autoFillEnabled = document.getElementById('AutoFillStory')?.checked;
            if (!autoFillEnabled) return;

            const currentRow = input.closest('tr');
            const tbody = document.getElementById('storyConfigBody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            const currentIndex = rows.indexOf(currentRow);
            const newValue = input.value;

            // Get field selector based on type
            let selector = '';
            switch (fieldType) {
                case 'startIndex': selector = '.storyStartIdx'; break;
                case 'beam': selector = '.storyBeamPrefix'; break;
                case 'girder': selector = '.storyGirderPrefix'; break;
                case 'column': selector = '.storyColumnPrefix'; break;
                case 'suffix': selector = '.storySuffix'; break;
            }

            // Cascade to all rows BELOW current row
            for (let i = currentIndex + 1; i < rows.length; i++) {
                const field = rows[i].querySelector(selector);
                if (field) {
                    if (fieldType === 'startIndex') {
                        // Start Index: Increment from current value
                        const baseValue = parseInt(newValue) || 1;
                        field.value = baseValue + (i - currentIndex);
                    } else {
                        // Prefixes and Suffix: Copy same value
                        field.value = newValue;
                    }
                }
            }
        }

        function deleteStoryRow(btn) {
            const tr = btn.closest('tr');
            if (tr) tr.remove();
            // Renumber all STT after deletion
            recalculateSTT();
        }

        function recalculateSTT() {
            const rows = document.querySelectorAll('#storyConfigBody tr');
            rows.forEach((row, idx) => {
                const sttInput = row.querySelector('.storyStartIdx');
                if (sttInput && idx === 0) {
                    // Keep first row's value as base
                } else if (sttInput && idx > 0) {
                    const prevStt = parseInt(rows[idx - 1].querySelector('.storyStartIdx')?.value) || idx;
                    sttInput.value = prevStt + 1;
                }
            });
        }

        function collectStoryConfigs() {
            const configs = [];
            const rows = document.querySelectorAll('#storyConfigBody tr');
            rows.forEach(row => {
                const name = row.querySelector('.storyName')?.textContent || '';
                const elev = parseFloat(row.querySelector('.storyElevHidden')?.value) || 0;
                const startIdx = parseInt(row.querySelector('.storyStartIdx')?.value) || 1;
                const beamPrefix = row.querySelector('.storyBeamPrefix')?.value || 'B';
                const girderPrefix = row.querySelector('.storyGirderPrefix')?.value || 'G';
                const columnPrefix = row.querySelector('.storyColumnPrefix')?.value || 'C';
                const suffix = row.querySelector('.storySuffix')?.value || '';

                if (name) {
                    configs.push({
                        StoryName: name,
                        Elevation: elev,
                        StartIndex: startIdx,
                        BeamPrefix: beamPrefix,
                        GirderPrefix: girderPrefix,
                        ColumnPrefix: columnPrefix,
                        Suffix: suffix
                    });
                }
            });
            return configs;
        }

        function getStoriesFromSAP() {
            const btn = document.getElementById('btnGetStories');
            const btnText = document.getElementById('btnGetStoriesText');

            // Show loading state
            btn.disabled = true;
            btnText.textContent = '‚è≥ Loading...';

            // Send message to C# to get stories
            window.chrome.webview.postMessage('GET_STORIES');
        }

        // Called from C# after retrieving stories
        function onStoriesReceived(storiesJson) {
            const btn = document.getElementById('btnGetStories');
            const btnText = document.getElementById('btnGetStoriesText');

            // Reset button
            btn.disabled = false;
            btnText.textContent = 'üì• Get Stories from SAP';

            try {
                const stories = JSON.parse(storiesJson);
                if (stories && stories.length > 0) {
                    loadStoryTable(stories);
                } else {
                    alert('Kh√¥ng t√¨m th·∫•y Story trong SAP2000. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi.');
                }
            } catch (e) {
                console.error('Parse stories error:', e);
                alert('L·ªói: ' + e.message);
            }
        }

        function doSave() {
            const getVal = (id) => {
                const el = document.getElementById(id);
                if (!el) return '';
                if (el.type === 'number') {
                    const num = parseFloat(el.value);
                    return isNaN(num) ? 0 : num;
                }
                return el.value || '';
            };
            const getChk = (id) => { const el = document.getElementById(id); return el ? el.checked : false; };

            const result = {
                General: {
                    AvailableDiameters: getSelectedDiameters(),
                    ZoneL1_Ratio: getVal('ZoneL1_Ratio'),
                    ZoneL2_Ratio: getVal('ZoneL2_Ratio'),
                    Unit: document.getElementById('Unit').value,
                    DecimalPlaces: data.General?.DecimalPlaces || 2,
                    TextHeight: getVal('TextHeight') || 1,
                    // Material Grades
                    SteelGradeName: getVal('SteelGradeName') || 'CB400-V',
                    SteelGradeMain: getVal('SteelGradeMain') || 400,
                    SteelGradeStirrup: getVal('SteelGradeStirrup') || 300,
                    ConcreteGradeName: getVal('ConcreteGradeName') || 'B25',
                    ConcreteGrade: getVal('ConcreteGrade') || 25
                },
                Beam: {
                    MainBarRange: getVal('MainBarRange') || '16-25',
                    StirrupBarRange: getVal('StirrupBarRange') || '8-10',
                    SideBarRange: getVal('SideBarRange') || '12-14',
                    CoverTop: getVal('CoverTop'),
                    CoverBot: getVal('CoverBot'),
                    CoverSide: getVal('CoverSide'),
                    // Clear Spacing
                    UseBarDiameterForSpacing: getChk('UseBarDiameterForSpacing'),
                    BarDiameterSpacingMultiplier: getVal('BarDiameterSpacingMultiplier') || 1.0,
                    MinClearSpacing: getVal('MinClearSpacing'),
                    MaxClearSpacing: getVal('MaxClearSpacing'),
                    // Torsion
                    TorsionDist_TopBar: getVal('TorsionDist_TopBar'),
                    TorsionDist_BotBar: getVal('TorsionDist_BotBar'),
                    TorsionDist_SideBar: getVal('TorsionDist_SideBar'),
                    // Auto Arrangement
                    MaxLayers: getVal('MaxLayers') || 2,
                    MinBarsPerLayer: getVal('MinBarsPerLayer') || 2,
                    WebBarMinHeight: getVal('WebBarMinHeight'),
                    PreferSingleDiameter: getChk('PreferSingleDiameter'),
                    PreferSymmetric: getChk('PreferSymmetric'),
                    PreferFewerBars: getChk('PreferFewerBars'),
                    PreferEvenDiameter: getChk('PreferEvenDiameter'),
                    // Stirrup
                    MinReinforcementRatio: getVal('MinReinforcementRatio'),
                    AutoLegsRules: getVal('AutoLegsRules') || '250-2 400-3 600-4',
                    AllowOddLegs: getChk('AllowOddLegs'),
                    // Continuous Beam Rules
                    ForceContinuousDiameter: getChk('ForceContinuousDiameter'),
                    SingleDiameterPerSpan: getChk('SingleDiameterPerSpan'),
                    AllowDiameterMixing: getChk('AllowDiameterMixing'),
                    MaxDiameterDiff: getVal('MaxDiameterDiff') || 1,
                    StandardBarLength: getVal('StandardBarLength') || 11700,
                    LapSpliceMultiplier: getVal('BeamLapSpliceMultiplier') || 40,
                    MatchTopLayerBars: getChk('MatchTopLayerBars')
                },
                Column: {
                    MainBarRange: getVal('ColMainBarRange') || '16-28',
                    StirrupBarRange: getVal('ColStirrupBarRange') || '8-10',
                    Cover: getVal('ColCover'),
                    LapSpliceMultiplier: getVal('LapSpliceMultiplier'),
                    MinBarsPerSide: getVal('MinBarsPerSide'),
                    MaxStirrupSpacing: getVal('MaxStirrupSpacing')
                },
                Naming: {
                    // Legacy prefix/suffix REMOVED - now use per-story config in StoryConfigs
                    GroupByAxis: getChk('GroupByAxis'),
                    MergeSameSection: getChk('MergeSameSection'),
                    AutoRenameOnSectionChange: getChk('AutoRenameOnSectionChange'),
                    SortCorner: parseInt(getVal('SortCorner')) || 0,
                    SortDirection: parseInt(getVal('SortDirection')) || 0
                },
                // Story Naming Config (PRIMARY)
                StoryTolerance: getVal('StoryTolerance') || 500,
                StoryConfigs: collectStoryConfigs(),
                Anchorage: collectAnchorageData(),
                Detailing: {
                    MaxBarLength: getVal('MaxBarLength') || 11700,
                    MinBarLength: getVal('MinBarLength') || 2000,
                    MinStaggerDistance: getVal('MinStaggerDistance') || 600,
                    StaggerFactorLd: getVal('StaggerFactorLd') || 1.3,
                    SkipSplice: getChk('SkipSplice'),
                    BeamRule: {
                        TopSpliceZone: parseInt(document.getElementById('BeamTopSpliceZone')?.value) || 2,
                        BotSpliceZone: parseInt(document.getElementById('BeamBotSpliceZone')?.value) || 0,
                        AllowLapSpliceInJoint: getChk('BeamAllowLapInJoint'),
                        SupportZoneRatio: 0.25
                    },
                    GirderRule: {
                        TopSpliceZone: parseInt(document.getElementById('GirderTopSpliceZone')?.value) || 1,
                        BotSpliceZone: parseInt(document.getElementById('GirderBotSpliceZone')?.value) || 0,
                        AllowLapSpliceInJoint: getChk('GirderAllowLapInJoint'),
                        SupportZoneRatio: 0.25
                    }
                }
            };

            window.chrome.webview.postMessage(JSON.stringify(result));
        }

        function doCancel() {
            window.chrome.webview.postMessage('CANCEL');
        }

        function doImport() {
            window.chrome.webview.postMessage('IMPORT');
        }

        function doExport() {
            window.chrome.webview.postMessage('EXPORT');
        }

        // Initialize form on load
        loadForm();
    </script>
</body>

</html>